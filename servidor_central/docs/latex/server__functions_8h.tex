\doxysection{include/servidor\+\_\+central/server\+\_\+functions.h File Reference}
\label{server__functions_8h}\index{include/servidor\_central/server\_functions.h@{include/servidor\_central/server\_functions.h}}


Funciones principales del servidor central de control de ascensores.  


\doxysubsubsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
struct \textbf{ server\+\_\+context\+\_\+t}
\begin{DoxyCompactList}\small\item\em Estructura para manejar el contexto del servidor. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \textbf{ init\+\_\+server\+\_\+context} (\textbf{ server\+\_\+context\+\_\+t} $\ast$server\+\_\+ctx, int port, const char $\ast$psk\+\_\+file)
\begin{DoxyCompactList}\small\item\em Inicializa el contexto del servidor. \end{DoxyCompactList}\item 
void \textbf{ cleanup\+\_\+server\+\_\+context} (\textbf{ server\+\_\+context\+\_\+t} $\ast$server\+\_\+ctx)
\begin{DoxyCompactList}\small\item\em Limpia y libera los recursos del contexto del servidor. \end{DoxyCompactList}\item 
int \textbf{ run\+\_\+server} (\textbf{ server\+\_\+context\+\_\+t} $\ast$server\+\_\+ctx)
\begin{DoxyCompactList}\small\item\em Inicia el bucle principal del servidor. \end{DoxyCompactList}\item 
int \textbf{ setup\+\_\+coap\+\_\+resources} (coap\+\_\+context\+\_\+t $\ast$ctx)
\begin{DoxyCompactList}\small\item\em Configura los recursos Co\+AP del servidor. \end{DoxyCompactList}\item 
int \textbf{ validate\+\_\+psk} (const char $\ast$identity, const char $\ast$psk, const char $\ast$psk\+\_\+file)
\begin{DoxyCompactList}\small\item\em Valida una clave PSK contra el archivo de claves. \end{DoxyCompactList}\item 
int \textbf{ handle\+\_\+floor\+\_\+request} (coap\+\_\+session\+\_\+t $\ast$session, coap\+\_\+pdu\+\_\+t $\ast$request, coap\+\_\+pdu\+\_\+t $\ast$response, sqlite3 $\ast$db)
\begin{DoxyCompactList}\small\item\em Procesa una solicitud de asignación de ascensor. \end{DoxyCompactList}\item 
int \textbf{ handle\+\_\+cabin\+\_\+request} (coap\+\_\+session\+\_\+t $\ast$session, coap\+\_\+pdu\+\_\+t $\ast$request, coap\+\_\+pdu\+\_\+t $\ast$response, sqlite3 $\ast$db)
\begin{DoxyCompactList}\small\item\em Procesa una solicitud específica de cabina. \end{DoxyCompactList}\item 
int \textbf{ assign\+\_\+elevator} (const char $\ast$edificio\+\_\+id, int piso\+\_\+origen, int piso\+\_\+destino, sqlite3 $\ast$db, char $\ast$$\ast$ascensor\+\_\+asignado, int $\ast$tiempo\+\_\+estimado)
\begin{DoxyCompactList}\small\item\em Ejecuta el algoritmo de asignación óptima de ascensores. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Funciones principales del servidor central de control de ascensores. 

\begin{DoxyAuthor}{Author}
Sistema de Control de Ascensores 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
2.\+0 
\end{DoxyVersion}
\begin{DoxyDate}{Date}
2025
\end{DoxyDate}
Este archivo contiene las declaraciones de las funciones principales del servidor central que maneja la comunicación Co\+AP/\+DTLS-\/\+PSK y la gestión de asignación de ascensores.

\begin{DoxySeeAlso}{See also}
\doxyref{main.\+c}{p.}{main_8c} 

\doxyref{dtls\+\_\+common\+\_\+config.\+h}{p.}{dtls__common__config_8h} 

\doxyref{logging.\+h}{p.}{logging_8h} 
\end{DoxySeeAlso}


\doxysubsection{Function Documentation}
\label{server__functions_8h_ae8dd2b1b14c29c984ea1a56fd2f12d3f} 
\index{server\_functions.h@{server\_functions.h}!assign\_elevator@{assign\_elevator}}
\index{assign\_elevator@{assign\_elevator}!server\_functions.h@{server\_functions.h}}
\doxysubsubsection{assign\_elevator()}
{\footnotesize\ttfamily int assign\+\_\+elevator (\begin{DoxyParamCaption}\item[{const char $\ast$}]{edificio\+\_\+id,  }\item[{int}]{piso\+\_\+origen,  }\item[{int}]{piso\+\_\+destino,  }\item[{sqlite3 $\ast$}]{db,  }\item[{char $\ast$$\ast$}]{ascensor\+\_\+asignado,  }\item[{int $\ast$}]{tiempo\+\_\+estimado }\end{DoxyParamCaption})}



Ejecuta el algoritmo de asignación óptima de ascensores. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em edificio\+\_\+id} & ID del edificio \\
\hline
\mbox{\texttt{ in}}  & {\em piso\+\_\+origen} & Piso de origen de la solicitud \\
\hline
\mbox{\texttt{ in}}  & {\em piso\+\_\+destino} & Piso de destino de la solicitud \\
\hline
\mbox{\texttt{ in}}  & {\em db} & Conexión a la base de datos \\
\hline
\mbox{\texttt{ out}}  & {\em ascensor\+\_\+asignado} & ID del ascensor asignado \\
\hline
\mbox{\texttt{ out}}  & {\em tiempo\+\_\+estimado} & Tiempo estimado de llegada en segundos\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
0 en caso de éxito, -\/1 en caso de error
\end{DoxyReturn}
Este algoritmo implementa la lógica de asignación\+:
\begin{DoxyItemize}
\item Consulta todos los ascensores disponibles del edificio
\item Calcula la distancia de cada ascensor al piso de origen
\item Considera la dirección de movimiento y carga actual
\item Selecciona el ascensor que minimice el tiempo de espera
\item Retorna la asignación óptima
\end{DoxyItemize}

\begin{DoxyNote}{Note}
El algoritmo prioriza ascensores libres sobre ocupados 
\end{DoxyNote}
\label{server__functions_8h_aa60a9510f2df860643e310eb01484487} 
\index{server\_functions.h@{server\_functions.h}!cleanup\_server\_context@{cleanup\_server\_context}}
\index{cleanup\_server\_context@{cleanup\_server\_context}!server\_functions.h@{server\_functions.h}}
\doxysubsubsection{cleanup\_server\_context()}
{\footnotesize\ttfamily void cleanup\+\_\+server\+\_\+context (\begin{DoxyParamCaption}\item[{\textbf{ server\+\_\+context\+\_\+t} $\ast$}]{server\+\_\+ctx }\end{DoxyParamCaption})}



Limpia y libera los recursos del contexto del servidor. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in,out}}  & {\em server\+\_\+ctx} & Puntero a la estructura de contexto del servidor\\
\hline
\end{DoxyParams}
Esta función libera todos los recursos asociados al servidor\+:
\begin{DoxyItemize}
\item Cierra el contexto Co\+AP
\item Libera la configuración SSL
\item Cierra la conexión a la base de datos
\item Libera memoria dinámica
\end{DoxyItemize}

\begin{DoxyNote}{Note}
Debe ser llamada al finalizar el servidor para evitar memory leaks 
\end{DoxyNote}
\begin{DoxySeeAlso}{See also}
\doxyref{init\+\_\+server\+\_\+context}{p.}{server__functions_8h_a4f61b5d1b962aae94872249c599e6634} 
\end{DoxySeeAlso}
\label{server__functions_8h_af7cc5ea773947ba92c506d609946774b} 
\index{server\_functions.h@{server\_functions.h}!handle\_cabin\_request@{handle\_cabin\_request}}
\index{handle\_cabin\_request@{handle\_cabin\_request}!server\_functions.h@{server\_functions.h}}
\doxysubsubsection{handle\_cabin\_request()}
{\footnotesize\ttfamily int handle\+\_\+cabin\+\_\+request (\begin{DoxyParamCaption}\item[{coap\+\_\+session\+\_\+t $\ast$}]{session,  }\item[{coap\+\_\+pdu\+\_\+t $\ast$}]{request,  }\item[{coap\+\_\+pdu\+\_\+t $\ast$}]{response,  }\item[{sqlite3 $\ast$}]{db }\end{DoxyParamCaption})}



Procesa una solicitud específica de cabina. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em session} & Sesión Co\+AP del cliente \\
\hline
\mbox{\texttt{ in}}  & {\em request} & Petición Co\+AP recibida \\
\hline
\mbox{\texttt{ in}}  & {\em response} & Respuesta Co\+AP a enviar \\
\hline
\mbox{\texttt{ in}}  & {\em db} & Conexión a la base de datos\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
0 en caso de éxito, -\/1 en caso de error
\end{DoxyReturn}
Esta función procesa las solicitudes de cabina específica\+:
\begin{DoxyItemize}
\item Valida que el ascensor solicitado esté disponible
\item Verifica que el ascensor pueda atender la solicitud
\item Asigna la tarea al ascensor específico
\item Actualiza la base de datos
\item Genera la respuesta de confirmación
\end{DoxyItemize}

\begin{DoxyNote}{Note}
Esta función es llamada automáticamente por el handler Co\+AP 
\end{DoxyNote}
\label{server__functions_8h_ae5aed47a7c0c6fde5608f7d5ac8487fc} 
\index{server\_functions.h@{server\_functions.h}!handle\_floor\_request@{handle\_floor\_request}}
\index{handle\_floor\_request@{handle\_floor\_request}!server\_functions.h@{server\_functions.h}}
\doxysubsubsection{handle\_floor\_request()}
{\footnotesize\ttfamily int handle\+\_\+floor\+\_\+request (\begin{DoxyParamCaption}\item[{coap\+\_\+session\+\_\+t $\ast$}]{session,  }\item[{coap\+\_\+pdu\+\_\+t $\ast$}]{request,  }\item[{coap\+\_\+pdu\+\_\+t $\ast$}]{response,  }\item[{sqlite3 $\ast$}]{db }\end{DoxyParamCaption})}



Procesa una solicitud de asignación de ascensor. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em session} & Sesión Co\+AP del cliente \\
\hline
\mbox{\texttt{ in}}  & {\em request} & Petición Co\+AP recibida \\
\hline
\mbox{\texttt{ in}}  & {\em response} & Respuesta Co\+AP a enviar \\
\hline
\mbox{\texttt{ in}}  & {\em db} & Conexión a la base de datos\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
0 en caso de éxito, -\/1 en caso de error
\end{DoxyReturn}
Esta función procesa las solicitudes de asignación\+:
\begin{DoxyItemize}
\item Valida el formato JSON de la petición
\item Consulta el estado actual de los ascensores
\item Ejecuta el algoritmo de asignación óptima
\item Actualiza la base de datos con la nueva tarea
\item Genera la respuesta JSON con la asignación
\end{DoxyItemize}

\begin{DoxyNote}{Note}
Esta función es llamada automáticamente por el handler Co\+AP 
\end{DoxyNote}
\label{server__functions_8h_a4f61b5d1b962aae94872249c599e6634} 
\index{server\_functions.h@{server\_functions.h}!init\_server\_context@{init\_server\_context}}
\index{init\_server\_context@{init\_server\_context}!server\_functions.h@{server\_functions.h}}
\doxysubsubsection{init\_server\_context()}
{\footnotesize\ttfamily int init\+\_\+server\+\_\+context (\begin{DoxyParamCaption}\item[{\textbf{ server\+\_\+context\+\_\+t} $\ast$}]{server\+\_\+ctx,  }\item[{int}]{port,  }\item[{const char $\ast$}]{psk\+\_\+file }\end{DoxyParamCaption})}



Inicializa el contexto del servidor. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ out}}  & {\em server\+\_\+ctx} & Puntero a la estructura de contexto del servidor \\
\hline
\mbox{\texttt{ in}}  & {\em port} & Puerto en el que escuchará el servidor \\
\hline
\mbox{\texttt{ in}}  & {\em psk\+\_\+file} & Ruta al archivo de claves PSK\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
0 en caso de éxito, -\/1 en caso de error
\end{DoxyReturn}
Esta función inicializa todos los componentes necesarios para el funcionamiento del servidor\+:
\begin{DoxyItemize}
\item Configura el contexto Co\+AP
\item Inicializa la configuración DTLS-\/\+PSK
\item Abre la conexión a la base de datos
\item Configura los recursos Co\+AP
\end{DoxyItemize}

\begin{DoxyNote}{Note}
La función debe ser llamada antes de iniciar el servidor 
\end{DoxyNote}
\begin{DoxySeeAlso}{See also}
\doxyref{cleanup\+\_\+server\+\_\+context}{p.}{server__functions_8h_aa60a9510f2df860643e310eb01484487} 
\end{DoxySeeAlso}
\label{server__functions_8h_ad564134db02b7a1914df699d680cfab6} 
\index{server\_functions.h@{server\_functions.h}!run\_server@{run\_server}}
\index{run\_server@{run\_server}!server\_functions.h@{server\_functions.h}}
\doxysubsubsection{run\_server()}
{\footnotesize\ttfamily int run\+\_\+server (\begin{DoxyParamCaption}\item[{\textbf{ server\+\_\+context\+\_\+t} $\ast$}]{server\+\_\+ctx }\end{DoxyParamCaption})}



Inicia el bucle principal del servidor. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em server\+\_\+ctx} & Puntero a la estructura de contexto del servidor\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
0 en caso de éxito, -\/1 en caso de error
\end{DoxyReturn}
Esta función inicia el bucle principal del servidor que\+:
\begin{DoxyItemize}
\item Escucha conexiones entrantes
\item Procesa solicitudes Co\+AP
\item Maneja la autenticación DTLS-\/\+PSK
\item Ejecuta los algoritmos de asignación de ascensores
\item Responde a los clientes
\end{DoxyItemize}

\begin{DoxyNote}{Note}
Esta función es bloqueante y solo retorna cuando el servidor se detiene 
\end{DoxyNote}
\begin{DoxySeeAlso}{See also}
\doxyref{init\+\_\+server\+\_\+context}{p.}{server__functions_8h_a4f61b5d1b962aae94872249c599e6634} 
\end{DoxySeeAlso}
\label{server__functions_8h_a7448045771096cb8102db2ac8373eaa8} 
\index{server\_functions.h@{server\_functions.h}!setup\_coap\_resources@{setup\_coap\_resources}}
\index{setup\_coap\_resources@{setup\_coap\_resources}!server\_functions.h@{server\_functions.h}}
\doxysubsubsection{setup\_coap\_resources()}
{\footnotesize\ttfamily int setup\+\_\+coap\+\_\+resources (\begin{DoxyParamCaption}\item[{coap\+\_\+context\+\_\+t $\ast$}]{ctx }\end{DoxyParamCaption})}



Configura los recursos Co\+AP del servidor. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em ctx} & Contexto Co\+AP del servidor\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
0 en caso de éxito, -\/1 en caso de error
\end{DoxyReturn}
Esta función registra los endpoints Co\+AP disponibles\+:
\begin{DoxyItemize}
\item /peticion\+\_\+piso\+: Para solicitudes de asignación de ascensor
\item /peticion\+\_\+cab\+: Para solicitudes específicas de cabina
\item /.well-\/known/core\+: Para descubrimiento de recursos
\end{DoxyItemize}

\begin{DoxyNote}{Note}
Debe ser llamada después de inicializar el contexto Co\+AP 
\end{DoxyNote}
\label{server__functions_8h_a1990dde3c205e63d4c093448a4b3ef34} 
\index{server\_functions.h@{server\_functions.h}!validate\_psk@{validate\_psk}}
\index{validate\_psk@{validate\_psk}!server\_functions.h@{server\_functions.h}}
\doxysubsubsection{validate\_psk()}
{\footnotesize\ttfamily int validate\+\_\+psk (\begin{DoxyParamCaption}\item[{const char $\ast$}]{identity,  }\item[{const char $\ast$}]{psk,  }\item[{const char $\ast$}]{psk\+\_\+file }\end{DoxyParamCaption})}



Valida una clave PSK contra el archivo de claves. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em identity} & Identidad del cliente \\
\hline
\mbox{\texttt{ in}}  & {\em psk} & Clave PSK proporcionada por el cliente \\
\hline
\mbox{\texttt{ in}}  & {\em psk\+\_\+file} & Ruta al archivo de claves PSK\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
1 si la clave es válida, 0 en caso contrario
\end{DoxyReturn}
Esta función valida la autenticación DTLS-\/\+PSK\+:
\begin{DoxyItemize}
\item Lee el archivo de claves PSK
\item Busca la identidad del cliente
\item Compara la clave proporcionada con la almacenada
\item Retorna el resultado de la validación
\end{DoxyItemize}

\begin{DoxyNote}{Note}
El archivo de claves debe contener pares identity\+:key 
\end{DoxyNote}
\begin{DoxySeeAlso}{See also}
\doxyref{psk\+\_\+validator.\+h}{p.}{psk__validator_8h} 
\end{DoxySeeAlso}
