\doxysection{src/main.c File Reference}
\hypertarget{main_8c}{}\label{main_8c}\index{src/main.c@{src/main.c}}


Servidor central de control de ascensores con protocolo Co\+AP sobre DTLS.  


{\ttfamily \#include $<$stdio.\+h$>$}\newline
{\ttfamily \#include $<$stdlib.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include $<$errno.\+h$>$}\newline
{\ttfamily \#include $<$signal.\+h$>$}\newline
{\ttfamily \#include $<$unistd.\+h$>$}\newline
{\ttfamily \#include $<$sys/time.\+h$>$}\newline
{\ttfamily \#include $<$arpa/inet.\+h$>$}\newline
{\ttfamily \#include $<$time.\+h$>$}\newline
{\ttfamily \#include $<$math.\+h$>$}\newline
{\ttfamily \#include $<$limits.\+h$>$}\newline
{\ttfamily \#include $<$coap3/coap.\+h$>$}\newline
{\ttfamily \#include $<$cjson/c\+JSON.\+h$>$}\newline
{\ttfamily \#include $<$openssl/rand.\+h$>$}\newline
{\ttfamily \#include "{}servidor\+\_\+central/logging.\+h"{}}\newline
{\ttfamily \#include "{}servidor\+\_\+central/psk\+\_\+validator.\+h"{}}\newline
Include dependency graph for main.\+c\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{main_8c__incl}
\end{center}
\end{figure}
\doxysubsubsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\Hypertarget{main_8c_a55052ee43a331f59e97c67c0148f68e1}\label{main_8c_a55052ee43a331f59e97c67c0148f68e1} 
\#define {\bfseries PSK\+\_\+\+SERVER\+\_\+\+HINT}~"{}Elevator\+Central\+Server"{}
\item 
\#define \mbox{\hyperlink{main_8c_a6eb895e2bffdc7771f2d72b06737c559}{RESOURCE\+\_\+\+FLOOR\+\_\+\+CALL}}~"{}peticion\+\_\+piso"{}
\begin{DoxyCompactList}\small\item\em Ruta del recurso Co\+AP para peticiones de piso. \end{DoxyCompactList}\item 
\#define \mbox{\hyperlink{main_8c_a173403b6552999fe67fb9cfffa92c874}{RESOURCE\+\_\+\+CABIN\+\_\+\+REQUEST}}~"{}peticion\+\_\+cabina"{}
\begin{DoxyCompactList}\small\item\em Ruta del recurso Co\+AP para peticiones de cabina. \end{DoxyCompactList}\item 
\#define \mbox{\hyperlink{main_8c_a28d06fc286f28044ed3380969700ff3f}{SERVER\+\_\+\+IP}}~"{}0.\+0.\+0.\+0"{}
\begin{DoxyCompactList}\small\item\em Dirección IP de escucha del servidor. \end{DoxyCompactList}\item 
\#define \mbox{\hyperlink{main_8c_ac42367fe5c999ec6650de83e9d72fe8c}{SERVER\+\_\+\+PORT}}~"{}5684"{}
\begin{DoxyCompactList}\small\item\em Puerto de escucha del servidor Co\+AP DTLS. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{main_8c_a83a44dda389e573327d70022c12d354b}{handle\+\_\+sigint}} (int signum)
\begin{DoxyCompactList}\small\item\em Manejador de señal para SIGINT (Ctrl+C) \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8c_aa7115e126eb6986fa2e1f6fb95ea839c}{generate\+\_\+unique\+\_\+task\+\_\+id}} (char \texorpdfstring{$\ast$}{*}task\+\_\+id\+\_\+out, size\+\_\+t len)
\begin{DoxyCompactList}\small\item\em Genera un ID único para una tarea de ascensor. \end{DoxyCompactList}\item 
int \mbox{\hyperlink{main_8c_a3c04138a5bfe5d72780bb7e82a18e627}{main}} (int argc, char \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}argv)
\begin{DoxyCompactList}\small\item\em Función principal del Servidor Central de Ascensores. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Servidor central de control de ascensores con protocolo Co\+AP sobre DTLS. 

\begin{DoxyAuthor}{Author}
Sistema de Ascensores 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
2024 
\end{DoxyDate}
\begin{DoxyVersion}{Version}
2.\+0
\end{DoxyVersion}
Este archivo implementa el servidor central que gestiona las solicitudes de ascensores desde múltiples API Gateways usando Co\+AP sobre DTLS con autenticación segura.

{\bfseries{Arquitectura del sistema\+:}}
\begin{DoxyItemize}
\item Servidor Co\+AP-\/\+DTLS que escucha en puerto 5684
\item Autenticación mutua mediante certificados seguros
\item Procesamiento stateless de solicitudes de ascensores
\item Balanceamiento de carga automático entre ascensores
\item Generación temporal de IDs únicos
\item Logging detallado para debugging y auditoría
\end{DoxyItemize}

{\bfseries{Recursos Co\+AP disponibles\+:}}
\begin{DoxyItemize}
\item {\ttfamily POST /peticion\+\_\+piso}\+: Solicitudes de llamada desde pisos
\item {\ttfamily POST /peticion\+\_\+cabina}\+: Solicitudes desde cabinas de ascensores
\end{DoxyItemize}

{\bfseries{Seguridad\+:}}
\begin{DoxyItemize}
\item Cifrado DTLS para todas las comunicaciones
\item Autenticación mutua con validación de identidades
\item Timeouts configurables para estabilidad de conexiones
\item Logging de todos los eventos de seguridad
\end{DoxyItemize}

{\bfseries{Funcionamiento\+:}}
\begin{DoxyEnumerate}
\item Inicialización del contexto Co\+AP con DTLS
\item Configuración de callbacks de autenticación
\item Registro de recursos Co\+AP disponibles
\item Bucle principal procesando solicitudes
\item Terminación con liberación de recursos
\end{DoxyEnumerate}

\begin{DoxyNote}{Note}
Requiere libcoap compilado con soporte DTLS/\+Open\+SSL 
\end{DoxyNote}
\begin{DoxySeeAlso}{See also}
\href{https://libcoap.net/doc/reference/4.3.0/}{\texttt{ https\+://libcoap.\+net/doc/reference/4.\+3.\+0/}} 
\end{DoxySeeAlso}


\doxysubsection{Macro Definition Documentation}
\Hypertarget{main_8c_a173403b6552999fe67fb9cfffa92c874}\label{main_8c_a173403b6552999fe67fb9cfffa92c874} 
\index{main.c@{main.c}!RESOURCE\_CABIN\_REQUEST@{RESOURCE\_CABIN\_REQUEST}}
\index{RESOURCE\_CABIN\_REQUEST@{RESOURCE\_CABIN\_REQUEST}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{RESOURCE\_CABIN\_REQUEST}{RESOURCE\_CABIN\_REQUEST}}
{\footnotesize\ttfamily \#define RESOURCE\+\_\+\+CABIN\+\_\+\+REQUEST~"{}peticion\+\_\+cabina"{}}



Ruta del recurso Co\+AP para peticiones de cabina. 

Define la ruta del endpoint Co\+AP que maneja las solicitudes de cabina (cabin requests) desde el interior de los ascensores. \Hypertarget{main_8c_a6eb895e2bffdc7771f2d72b06737c559}\label{main_8c_a6eb895e2bffdc7771f2d72b06737c559} 
\index{main.c@{main.c}!RESOURCE\_FLOOR\_CALL@{RESOURCE\_FLOOR\_CALL}}
\index{RESOURCE\_FLOOR\_CALL@{RESOURCE\_FLOOR\_CALL}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{RESOURCE\_FLOOR\_CALL}{RESOURCE\_FLOOR\_CALL}}
{\footnotesize\ttfamily \#define RESOURCE\+\_\+\+FLOOR\+\_\+\+CALL~"{}peticion\+\_\+piso"{}}



Ruta del recurso Co\+AP para peticiones de piso. 

Define la ruta del endpoint Co\+AP que maneja las solicitudes de llamada de piso (floor calls) desde botones externos. \Hypertarget{main_8c_a28d06fc286f28044ed3380969700ff3f}\label{main_8c_a28d06fc286f28044ed3380969700ff3f} 
\index{main.c@{main.c}!SERVER\_IP@{SERVER\_IP}}
\index{SERVER\_IP@{SERVER\_IP}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{SERVER\_IP}{SERVER\_IP}}
{\footnotesize\ttfamily \#define SERVER\+\_\+\+IP~"{}0.\+0.\+0.\+0"{}}



Dirección IP de escucha del servidor. 

Dirección IP en la que el servidor Co\+AP escuchará conexiones. "{}0.\+0.\+0.\+0"{} indica que escuchará en todas las interfaces disponibles. \Hypertarget{main_8c_ac42367fe5c999ec6650de83e9d72fe8c}\label{main_8c_ac42367fe5c999ec6650de83e9d72fe8c} 
\index{main.c@{main.c}!SERVER\_PORT@{SERVER\_PORT}}
\index{SERVER\_PORT@{SERVER\_PORT}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{SERVER\_PORT}{SERVER\_PORT}}
{\footnotesize\ttfamily \#define SERVER\+\_\+\+PORT~"{}5684"{}}



Puerto de escucha del servidor Co\+AP DTLS. 

Puerto en el que el servidor Co\+AP con DTLS escuchará conexiones. El puerto 5684 es el puerto estándar para Co\+AP sobre DTLS. 

\doxysubsection{Function Documentation}
\Hypertarget{main_8c_aa7115e126eb6986fa2e1f6fb95ea839c}\label{main_8c_aa7115e126eb6986fa2e1f6fb95ea839c} 
\index{main.c@{main.c}!generate\_unique\_task\_id@{generate\_unique\_task\_id}}
\index{generate\_unique\_task\_id@{generate\_unique\_task\_id}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{generate\_unique\_task\_id()}{generate\_unique\_task\_id()}}
{\footnotesize\ttfamily void generate\+\_\+unique\+\_\+task\+\_\+id (\begin{DoxyParamCaption}\item[{char \texorpdfstring{$\ast$}{*}}]{task\+\_\+id\+\_\+out,  }\item[{size\+\_\+t}]{len }\end{DoxyParamCaption})}



Genera un ID único para una tarea de ascensor. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ out}}  & {\em task\+\_\+id\+\_\+out} & Buffer donde se almacenará el ID generado \\
\hline
\mbox{\texttt{ in}}  & {\em len} & Tamaño del buffer de salida en bytes\\
\hline
\end{DoxyParams}
Esta función genera un identificador único para tareas de ascensor basado en el timestamp actual del sistema con precisión de milisegundos.

{\bfseries{Formato del ID generado\+:}} 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{stringliteral}{"{}T\_\{segundos\_unix\}\{milisegundos\}"{}}}

\end{DoxyCode}


{\bfseries{Ejemplo de ID\+:}}
\begin{DoxyItemize}
\item "{}\+T\+\_\+1640995200123"{} donde\+:
\begin{DoxyItemize}
\item T\+\_\+\+: Prefijo identificador de tarea
\item 1640995200\+: Segundos desde epoch Unix
\item 123\+: Milisegundos (3 dígitos)
\end{DoxyItemize}
\end{DoxyItemize}

{\bfseries{Características\+:}}
\begin{DoxyItemize}
\item Unicidad temporal garantizada
\item Formato legible y ordenable
\item Precisión de milisegundos
\item Compatible con sistemas distribuidos
\end{DoxyItemize}

{\bfseries{Limitaciones\+:}}
\begin{DoxyItemize}
\item No es thread-\/safe (para entornos multihilo usar sincronización)
\item Dependiente del reloj del sistema
\item Máximo 1,000 IDs por segundo (limitación de milisegundos)
\end{DoxyItemize}

{\bfseries{Uso típico\+:}} 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{char}\ task\_id[32];}
\DoxyCodeLine{\mbox{\hyperlink{main_8c_aa7115e126eb6986fa2e1f6fb95ea839c}{generate\_unique\_task\_id}}(task\_id,\ \textcolor{keyword}{sizeof}(task\_id));}
\DoxyCodeLine{\textcolor{comment}{//\ task\_id\ contiene\ "{}T\_1640995200123"{}}}

\end{DoxyCode}


\begin{DoxyNote}{Note}
El buffer de salida debe tener al menos 32 caracteres 

Para entornos multihilo considerar usar mutex o contadores atómicos 
\end{DoxyNote}
\begin{DoxySeeAlso}{See also}
gettimeofday() 

snprintf() 
\end{DoxySeeAlso}
\Hypertarget{main_8c_a83a44dda389e573327d70022c12d354b}\label{main_8c_a83a44dda389e573327d70022c12d354b} 
\index{main.c@{main.c}!handle\_sigint@{handle\_sigint}}
\index{handle\_sigint@{handle\_sigint}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{handle\_sigint()}{handle\_sigint()}}
{\footnotesize\ttfamily void handle\+\_\+sigint (\begin{DoxyParamCaption}\item[{int}]{signum }\end{DoxyParamCaption})}



Manejador de señal para SIGINT (Ctrl+C) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em signum} & Número de señal recibida (se espera SIGINT = 2)\\
\hline
\end{DoxyParams}
Esta función implementa el manejo de la señal SIGINT\+:

{\bfseries{Funcionalidad\+:}}
\begin{DoxyItemize}
\item Establece la bandera global \textquotesingle{}running\textquotesingle{} a 0
\item Permite que el bucle principal termine de forma controlada
\item Registra el evento en el log del sistema
\item Evita terminación abrupta del servidor
\end{DoxyItemize}

{\bfseries{Flujo de terminación\+:}}
\begin{DoxyEnumerate}
\item Usuario presiona Ctrl+C
\item Sistema envía SIGINT al proceso
\item Esta función establece running = 0
\item Bucle principal detecta el cambio y termina
\item Se ejecutan rutinas de limpieza en \doxylink{main_8c_a3c04138a5bfe5d72780bb7e82a18e627}{main()}
\end{DoxyEnumerate}

{\bfseries{Seguridad\+:}}
\begin{DoxyItemize}
\item No realiza operaciones complejas en el handler
\item Solo modifica la bandera de control
\item Es thread-\/safe para el contexto de señales
\end{DoxyItemize}

\begin{DoxyNote}{Note}
Esta función debe ser registrada con signal() o sigaction() 

Solo modifica variables globales para evitar problemas de reentrancia 
\end{DoxyNote}
\begin{DoxySeeAlso}{See also}
running 

\doxylink{main_8c_a3c04138a5bfe5d72780bb7e82a18e627}{main()} 
\end{DoxySeeAlso}
\Hypertarget{main_8c_a3c04138a5bfe5d72780bb7e82a18e627}\label{main_8c_a3c04138a5bfe5d72780bb7e82a18e627} 
\index{main.c@{main.c}!main@{main}}
\index{main@{main}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily int main (\begin{DoxyParamCaption}\item[{int}]{argc,  }\item[{char \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}}]{argv }\end{DoxyParamCaption})}



Función principal del Servidor Central de Ascensores. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em argc} & Número de argumentos de línea de comandos \\
\hline
\mbox{\texttt{ in}}  & {\em argv} & Array de argumentos de línea de comandos\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
EXIT\+\_\+\+SUCCESS (0) si el servidor termina correctamente, EXIT\+\_\+\+FAILURE (1) en caso de error
\end{DoxyReturn}
Esta función implementa el punto de entrada principal del servidor central de control de ascensores. Configura y ejecuta un servidor Co\+AP con DTLS-\/\+PSK que gestiona solicitudes de ascensores desde API Gateways.

{\bfseries{Flujo de inicialización\+:}}
\begin{DoxyEnumerate}
\item {\bfseries{Configuración de señales}}\+: Registra manejador para SIGINT (Ctrl+C)
\item {\bfseries{Inicialización de lib\+Co\+AP}}\+: Configura logging y contexto Co\+AP
\item {\bfseries{Configuración de red}}\+: Establece dirección y puerto de escucha
\item {\bfseries{Configuración DTLS-\/\+PSK}}\+: Configura autenticación y cifrado
\item {\bfseries{Inicialización PSK}}\+: Carga validador de claves precompartidas
\item {\bfseries{Registro de recursos}}\+: Configura endpoints Co\+AP
\item {\bfseries{Bucle principal}}\+: Procesa solicitudes hasta terminación
\end{DoxyEnumerate}

{\bfseries{Configuración de seguridad\+:}}
\begin{DoxyItemize}
\item Autenticación DTLS-\/\+PSK con claves precompartidas
\item Validación de identidades de clientes
\item Cifrado de todas las comunicaciones
\item Timeouts optimizados para estabilidad
\end{DoxyItemize}

{\bfseries{Recursos Co\+AP registrados\+:}}
\begin{DoxyItemize}
\item {\ttfamily POST /peticion\+\_\+piso}\+: Solicitudes de llamada de piso
\item {\ttfamily POST /peticion\+\_\+cabina}\+: Solicitudes de cabina
\end{DoxyItemize}

{\bfseries{Gestión de errores\+:}}
\begin{DoxyItemize}
\item Validación de configuración de red
\item Verificación de inicialización de componentes
\item Logging detallado de errores críticos
\item Terminación en caso de fallo
\end{DoxyItemize}

{\bfseries{Terminación\+:}}
\begin{DoxyItemize}
\item Respuesta a señal SIGINT (Ctrl+C)
\item Cierre de conexiones DTLS
\item Limpieza de contexto Co\+AP
\end{DoxyItemize}

{\bfseries{Configuración de red\+:}}
\begin{DoxyItemize}
\item Puerto\+: 5684 (estándar Co\+AP-\/\+DTLS)
\item Interfaz\+: 0.\+0.\+0.\+0 (todas las interfaces)
\item Protocolo\+: UDP con DTLS
\end{DoxyItemize}

\begin{DoxyNote}{Note}
El servidor se ejecuta indefinidamente hasta recibir SIGINT 

Requiere archivo de claves PSK para funcionamiento completo 
\end{DoxyNote}
\begin{DoxySeeAlso}{See also}
\doxylink{main_8c_a83a44dda389e573327d70022c12d354b}{handle\+\_\+sigint()} 

session\+\_\+event\+\_\+handler() 

get\+\_\+psk\+\_\+info() 

\doxylink{psk__validator_8c_af84bfa633858d22629eeb419e53a30c1}{psk\+\_\+validator\+\_\+init()} 

hnd\+\_\+floor\+\_\+call() 

hnd\+\_\+cabin\+\_\+request() 
\end{DoxySeeAlso}
