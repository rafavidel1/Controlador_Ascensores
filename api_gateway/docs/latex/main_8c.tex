\doxysection{src/main.c File Reference}
\hypertarget{main_8c}{}\label{main_8c}\index{src/main.c@{src/main.c}}


Punto de entrada principal del API Gateway del Sistema de Control de Ascensores.  


{\ttfamily \#include $<$stdio.\+h$>$}\newline
{\ttfamily \#include $<$stdlib.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include $<$signal.\+h$>$}\newline
{\ttfamily \#include $<$errno.\+h$>$}\newline
{\ttfamily \#include $<$sys/socket.\+h$>$}\newline
{\ttfamily \#include $<$netinet/in.\+h$>$}\newline
{\ttfamily \#include $<$arpa/inet.\+h$>$}\newline
{\ttfamily \#include $<$time.\+h$>$}\newline
{\ttfamily \#include $<$stdbool.\+h$>$}\newline
{\ttfamily \#include $<$coap3/coap.\+h$>$}\newline
{\ttfamily \#include $<$coap3/coap\+\_\+address.\+h$>$}\newline
{\ttfamily \#include $<$coap3/coap\+\_\+event.\+h$>$}\newline
{\ttfamily \#include "{}api\+\_\+gateway/api\+\_\+handlers.\+h"{}}\newline
{\ttfamily \#include "{}api\+\_\+gateway/elevator\+\_\+state\+\_\+manager.\+h"{}}\newline
{\ttfamily \#include "{}api\+\_\+gateway/can\+\_\+bridge.\+h"{}}\newline
{\ttfamily \#include $<$c\+JSON.\+h$>$}\newline
{\ttfamily \#include "{}api\+\_\+gateway/logging\+\_\+gw.\+h"{}}\newline
{\ttfamily \#include "{}dotenv.\+h"{}}\newline
{\ttfamily \#include $<$unistd.\+h$>$}\newline
{\ttfamily \#include "{}psk\+\_\+manager.\+h"{}}\newline
{\ttfamily \#include "{}api\+\_\+gateway/execution\+\_\+logger.\+h"{}}\newline
Include dependency graph for main.\+c\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{main_8c__incl}
\end{center}
\end{figure}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{main_8c_acfc4758bf8842f413c4d9e1c5ce6053d}{inicializar\+\_\+mi\+\_\+simulacion\+\_\+ascensor}} (void)
\begin{DoxyCompactList}\small\item\em Inicializa el simulador de ascensores. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{main_8c_a5c86f739de835826e9fa6dd607c52ec9}{simular\+\_\+eventos\+\_\+ascensor}} (void)
\begin{DoxyCompactList}\small\item\em Ejecuta una secuencia de eventos simulados de ascensor desde JSON de forma no-\/bloqueante. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{main_8c_a4a5671b859ec369365a41ed5e9d2084d}{procesar\+\_\+siguiente\+\_\+peticion\+\_\+simulacion}} (void)
\begin{DoxyCompactList}\small\item\em Procesa la siguiente petición de la simulación no-\/bloqueante. \end{DoxyCompactList}\item 
coap\+\_\+session\+\_\+t \texorpdfstring{$\ast$}{*} \mbox{\hyperlink{main_8c_a7910799dc4997ea7ff42bb0339134d94}{get\+\_\+or\+\_\+create\+\_\+central\+\_\+server\+\_\+dtls\+\_\+session}} (coap\+\_\+context\+\_\+t \texorpdfstring{$\ast$}{*}ctx)
\begin{DoxyCompactList}\small\item\em Obtiene o crea una sesión DTLS con el servidor central. \end{DoxyCompactList}\item 
int \mbox{\hyperlink{main_8c_a0ddf1224851353fc92bfbff6f499fa97}{main}} (int argc, char \texorpdfstring{$\ast$}{*}argv\mbox{[}$\,$\mbox{]})
\begin{DoxyCompactList}\small\item\em Main function for the API Gateway. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
volatile sig\+\_\+atomic\+\_\+t \mbox{\hyperlink{main_8c_a8a485bed3bbf69f7556aa3167043d7e2}{quit\+\_\+main\+\_\+loop}} = 0
\begin{DoxyCompactList}\small\item\em Bandera global para controlar el bucle principal de la aplicación. \end{DoxyCompactList}\item 
elevator\+\_\+group\+\_\+state\+\_\+t \mbox{\hyperlink{main_8c_a2e69b946477ed035db425886fe261a13}{managed\+\_\+elevator\+\_\+group}}
\begin{DoxyCompactList}\small\item\em Estado global del grupo de ascensores gestionado por este gateway. \end{DoxyCompactList}\item 
coap\+\_\+context\+\_\+t \texorpdfstring{$\ast$}{*} \mbox{\hyperlink{main_8c_abc8b9aeba00fbf6aeb7c811c034f383c}{g\+\_\+coap\+\_\+context}} = NULL
\begin{DoxyCompactList}\small\item\em Contexto Co\+AP global para la simulación y gestión de sesiones. \end{DoxyCompactList}\item 
coap\+\_\+session\+\_\+t \texorpdfstring{$\ast$}{*} \mbox{\hyperlink{main_8c_abe546e2cc7517fb0f6e0218ca1e3ff10}{g\+\_\+dtls\+\_\+session\+\_\+to\+\_\+central\+\_\+server}} = NULL
\begin{DoxyCompactList}\small\item\em Sesión DTLS global con el servidor central. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Punto de entrada principal del API Gateway del Sistema de Control de Ascensores. 

\begin{DoxyAuthor}{Author}
Sistema de Control de Ascensores 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
2025 
\end{DoxyDate}
\begin{DoxyVersion}{Version}
2.\+0
\end{DoxyVersion}
Este archivo implementa el API Gateway que actúa como intermediario entre los controladores CAN de ascensores y el servidor central. Sus funciones principales\+:


\begin{DoxyItemize}
\item {\bfseries{Inicialización Co\+AP}}\+: Configuración del contexto Co\+AP con soporte DTLS
\item {\bfseries{Gestión de Recursos}}\+: Registro de endpoints Co\+AP para recibir solicitudes
\item {\bfseries{Puente CAN-\/\+Co\+AP}}\+: Transformación de mensajes CAN a solicitudes Co\+AP
\item {\bfseries{Gestión de Estado}}\+: Mantenimiento del estado local de ascensores
\item {\bfseries{Comunicación Segura}}\+: Establecimiento de sesiones DTLS con servidor central
\item {\bfseries{Simulación}}\+: Simulación de movimiento de ascensores para testing
\item {\bfseries{Manejo de Señales}}\+: Terminación elegante con SIGINT
\end{DoxyItemize}

El gateway procesa dos tipos principales de solicitudes\+:
\begin{DoxyItemize}
\item Llamadas de piso (floor calls) desde botones externos
\item Solicitudes de cabina (cabin requests) desde interior del ascensor
\end{DoxyItemize}

\begin{DoxySeeAlso}{See also}
\doxylink{api__handlers_8h}{api\+\_\+handlers.\+h} 

elevator\+\_\+state\+\_\+manager.\+h 

can\+\_\+bridge.\+h 

coap\+\_\+config.\+h 
\end{DoxySeeAlso}


\doxysubsection{Function Documentation}
\Hypertarget{main_8c_a7910799dc4997ea7ff42bb0339134d94}\label{main_8c_a7910799dc4997ea7ff42bb0339134d94} 
\index{main.c@{main.c}!get\_or\_create\_central\_server\_dtls\_session@{get\_or\_create\_central\_server\_dtls\_session}}
\index{get\_or\_create\_central\_server\_dtls\_session@{get\_or\_create\_central\_server\_dtls\_session}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{get\_or\_create\_central\_server\_dtls\_session()}{get\_or\_create\_central\_server\_dtls\_session()}}
{\footnotesize\ttfamily coap\+\_\+session\+\_\+t \texorpdfstring{$\ast$}{*} get\+\_\+or\+\_\+create\+\_\+central\+\_\+server\+\_\+dtls\+\_\+session (\begin{DoxyParamCaption}\item[{coap\+\_\+context\+\_\+t \texorpdfstring{$\ast$}{*}}]{ctx }\end{DoxyParamCaption})}



Obtiene o crea una sesión DTLS con el servidor central. 


\begin{DoxyParams}{Parameters}
{\em ctx} & Contexto Co\+AP a utilizar para la sesión \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Puntero a la sesión DTLS establecida, o NULL en caso de error
\end{DoxyReturn}
Esta función implementa un patrón singleton para la gestión de sesiones DTLS con el servidor central. Reutiliza sesiones existentes cuando están activas y crea nuevas sesiones cuando es necesario.

Comportamiento\+:
\begin{DoxyEnumerate}
\item Si existe una sesión activa y establecida, la reutiliza
\item Si la sesión existe pero no está establecida, la libera y crea una nueva
\item Si no existe sesión, crea una nueva con configuración DTLS-\/\+PSK
\item Registra el manejador de eventos para gestión automática de la sesión
\end{DoxyEnumerate}

La función utiliza las siguientes configuraciones\+:
\begin{DoxyItemize}
\item IP del servidor\+: CENTRAL\+\_\+\+SERVER\+\_\+\+IP
\item Puerto del servidor\+: CENTRAL\+\_\+\+SERVER\+\_\+\+PORT ~\newline

\item Identidad PSK\+: IDENTITY\+\_\+\+TO\+\_\+\+PRESENT\+\_\+\+TO\+\_\+\+SERVER
\item Clave PSK\+: KEY\+\_\+\+FOR\+\_\+\+SERVER
\end{DoxyItemize}

\begin{DoxySeeAlso}{See also}
event\+\_\+handler\+\_\+gw() 

coap\+\_\+config.\+h 
\end{DoxySeeAlso}
\Hypertarget{main_8c_acfc4758bf8842f413c4d9e1c5ce6053d}\label{main_8c_acfc4758bf8842f413c4d9e1c5ce6053d} 
\index{main.c@{main.c}!inicializar\_mi\_simulacion\_ascensor@{inicializar\_mi\_simulacion\_ascensor}}
\index{inicializar\_mi\_simulacion\_ascensor@{inicializar\_mi\_simulacion\_ascensor}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{inicializar\_mi\_simulacion\_ascensor()}{inicializar\_mi\_simulacion\_ascensor()}}
{\footnotesize\ttfamily void inicializar\+\_\+mi\+\_\+simulacion\+\_\+ascensor (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Inicializa el simulador de ascensores. 

Esta función configura el simulador registrando el callback de respuesta CAN en el puente CAN-\/\+Co\+AP del API Gateway y cargando los datos de simulación desde el archivo JSON.

{\bfseries{Operaciones realizadas\+:}}
\begin{DoxyItemize}
\item Registro del callback de respuesta CAN
\item Carga de datos de simulación desde JSON
\item Inicialización de estructuras internas
\item Configuración de logging del simulador
\end{DoxyItemize}

\begin{DoxySeeAlso}{See also}
\doxylink{can__bridge_8c_a82b3383904e65573e79b59f4b7c5ef15}{ag\+\_\+can\+\_\+bridge\+\_\+register\+\_\+send\+\_\+callback()} 

\doxylink{simulation__loader_8c_a189a79642cdf0001b3a29062e4180af3}{cargar\+\_\+datos\+\_\+simulacion()} 

\doxylink{mi__simulador__ascensor_8c_adfcf33ff0806b77c246bbd870b029566}{mi\+\_\+simulador\+\_\+recibe\+\_\+can\+\_\+gw()} 
\end{DoxySeeAlso}
\Hypertarget{main_8c_a0ddf1224851353fc92bfbff6f499fa97}\label{main_8c_a0ddf1224851353fc92bfbff6f499fa97} 
\index{main.c@{main.c}!main@{main}}
\index{main@{main}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily int main (\begin{DoxyParamCaption}\item[{int}]{argc,  }\item[{char \texorpdfstring{$\ast$}{*}}]{argv\mbox{[}$\,$\mbox{]} }\end{DoxyParamCaption})}



Main function for the API Gateway. 

Initializes libcoap, sets up the Co\+AP server endpoint for listening to elevator clients, registers Co\+AP resource handlers, and enters the main I/O processing loop. The gateway listens for client requests, forwards them to a central server, and relays responses back to the clients.


\begin{DoxyParams}{Parameters}
{\em argc} & Número de argumentos de línea de comandos \\
\hline
{\em argv} & Array de argumentos de línea de comandos argv\mbox{[}1\mbox{]} (opcional)\+: Puerto de escucha (por defecto usa GW\+\_\+\+LISTEN\+\_\+\+PORT)\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
EXIT\+\_\+\+SUCCESS on successful execution and shutdown, EXIT\+\_\+\+FAILURE on error. 
\end{DoxyReturn}
\Hypertarget{main_8c_a4a5671b859ec369365a41ed5e9d2084d}\label{main_8c_a4a5671b859ec369365a41ed5e9d2084d} 
\index{main.c@{main.c}!procesar\_siguiente\_peticion\_simulacion@{procesar\_siguiente\_peticion\_simulacion}}
\index{procesar\_siguiente\_peticion\_simulacion@{procesar\_siguiente\_peticion\_simulacion}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{procesar\_siguiente\_peticion\_simulacion()}{procesar\_siguiente\_peticion\_simulacion()}}
{\footnotesize\ttfamily bool procesar\+\_\+siguiente\+\_\+peticion\+\_\+simulacion (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Procesa la siguiente petición de la simulación no-\/bloqueante. 

Esta función debe llamarse desde el main loop para ejecutar las peticiones de forma incremental, permitiendo que el simulador de movimiento funcione en paralelo.

\begin{DoxyReturn}{Returns}
true si la simulación continúa, false si ha terminado 
\end{DoxyReturn}
\Hypertarget{main_8c_a5c86f739de835826e9fa6dd607c52ec9}\label{main_8c_a5c86f739de835826e9fa6dd607c52ec9} 
\index{main.c@{main.c}!simular\_eventos\_ascensor@{simular\_eventos\_ascensor}}
\index{simular\_eventos\_ascensor@{simular\_eventos\_ascensor}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{simular\_eventos\_ascensor()}{simular\_eventos\_ascensor()}}
{\footnotesize\ttfamily void simular\+\_\+eventos\+\_\+ascensor (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Ejecuta una secuencia de eventos simulados de ascensor desde JSON de forma no-\/bloqueante. 

Esta función reemplaza la simulación bloqueante anterior. Ahora la simulación se ejecuta de forma incremental, permitiendo que el main loop procese I/O y ejecute la simulación de movimiento entre peticiones.

{\bfseries{Cambios principales\+:}}
\begin{DoxyItemize}
\item Simulación no-\/bloqueante (una petición por llamada)
\item Control regresa al main loop para permitir movimiento de ascensores
\item Intervalo configurable entre peticiones
\item Estado global para rastrear progreso
\end{DoxyItemize}

{\bfseries{Proceso de simulación\+:}}
\begin{DoxyEnumerate}
\item Inicialización\+: selecciona edificio y configura estado
\item Ejecución incremental\+: una petición por llamada
\item El main loop ejecuta tanto I/O como simulación de movimiento
\item Finalización automática al completar todas las peticiones
\end{DoxyEnumerate}

\begin{DoxyNote}{Note}
Esta función debe llamarse desde el main loop para ser no-\/bloqueante 
\end{DoxyNote}
\begin{DoxySeeAlso}{See also}
simulate\+\_\+elevator\+\_\+group\+\_\+step() -\/ se ejecuta en paralelo 
\end{DoxySeeAlso}


\doxysubsection{Variable Documentation}
\Hypertarget{main_8c_abc8b9aeba00fbf6aeb7c811c034f383c}\label{main_8c_abc8b9aeba00fbf6aeb7c811c034f383c} 
\index{main.c@{main.c}!g\_coap\_context@{g\_coap\_context}}
\index{g\_coap\_context@{g\_coap\_context}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{g\_coap\_context}{g\_coap\_context}}
{\footnotesize\ttfamily coap\+\_\+context\+\_\+t\texorpdfstring{$\ast$}{*} g\+\_\+coap\+\_\+context = NULL}



Contexto Co\+AP global para la simulación y gestión de sesiones. 

Contexto Co\+AP global del API Gateway.

Contexto principal utilizado para todas las operaciones Co\+AP, incluyendo la simulación de ascensores y la gestión de sesiones DTLS. \Hypertarget{main_8c_abe546e2cc7517fb0f6e0218ca1e3ff10}\label{main_8c_abe546e2cc7517fb0f6e0218ca1e3ff10} 
\index{main.c@{main.c}!g\_dtls\_session\_to\_central\_server@{g\_dtls\_session\_to\_central\_server}}
\index{g\_dtls\_session\_to\_central\_server@{g\_dtls\_session\_to\_central\_server}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{g\_dtls\_session\_to\_central\_server}{g\_dtls\_session\_to\_central\_server}}
{\footnotesize\ttfamily coap\+\_\+session\+\_\+t\texorpdfstring{$\ast$}{*} g\+\_\+dtls\+\_\+session\+\_\+to\+\_\+central\+\_\+server = NULL}



Sesión DTLS global con el servidor central. 

Mantiene la conexión segura DTLS con el servidor central para el envío de solicitudes de asignación de ascensores. Se reutiliza para múltiples solicitudes para eficiencia. \Hypertarget{main_8c_a2e69b946477ed035db425886fe261a13}\label{main_8c_a2e69b946477ed035db425886fe261a13} 
\index{main.c@{main.c}!managed\_elevator\_group@{managed\_elevator\_group}}
\index{managed\_elevator\_group@{managed\_elevator\_group}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{managed\_elevator\_group}{managed\_elevator\_group}}
{\footnotesize\ttfamily elevator\+\_\+group\+\_\+state\+\_\+t managed\+\_\+elevator\+\_\+group}



Estado global del grupo de ascensores gestionado por este gateway. 

Grupo de ascensores gestionado.

Estado del grupo de ascensores gestionado.

Estado del grupo de ascensores gestionado por este gateway.

Contiene el estado completo de todos los ascensores del edificio gestionado por este API Gateway, incluyendo posiciones actuales, tareas asignadas, estados de puertas y disponibilidad.

\begin{DoxySeeAlso}{See also}
elevator\+\_\+group\+\_\+state\+\_\+t 

elevator\+\_\+state\+\_\+manager.\+h 
\end{DoxySeeAlso}
\Hypertarget{main_8c_a8a485bed3bbf69f7556aa3167043d7e2}\label{main_8c_a8a485bed3bbf69f7556aa3167043d7e2} 
\index{main.c@{main.c}!quit\_main\_loop@{quit\_main\_loop}}
\index{quit\_main\_loop@{quit\_main\_loop}!main.c@{main.c}}
\doxysubsubsection{\texorpdfstring{quit\_main\_loop}{quit\_main\_loop}}
{\footnotesize\ttfamily volatile sig\+\_\+atomic\+\_\+t quit\+\_\+main\+\_\+loop = 0}



Bandera global para controlar el bucle principal de la aplicación. 

Bandera para indicar si el bucle principal debe terminar.

Esta bandera se establece a 1 por el manejador de señal SIGINT (handle\+\_\+sigint\+\_\+gw) para indicar que la aplicación debe terminar de manera elegante.

\begin{DoxySeeAlso}{See also}
\doxylink{api__handlers_8c_a7fd01dcda5b603f45f20d97c84d9260b}{handle\+\_\+sigint\+\_\+gw()} 
\end{DoxySeeAlso}
