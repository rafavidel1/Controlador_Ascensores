\doxysection{src/main.c File Reference}
\label{main_8c}\index{src/main.c@{src/main.c}}


Punto de entrada principal del API Gateway del Sistema de Control de Ascensores.  


\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
static char $\ast$ \textbf{ generate\+\_\+unique\+\_\+identity} ()
\item 
static char $\ast$ \textbf{ generate\+\_\+unique\+\_\+psk\+\_\+key} ()
\item 
static void \textbf{ simulate\+\_\+elevator\+\_\+group\+\_\+step} (coap\+\_\+context\+\_\+t $\ast$ctx, \textbf{ elevator\+\_\+group\+\_\+state\+\_\+t} $\ast$group)
\begin{DoxyCompactList}\small\item\em Simula un paso de movimiento para todos los ascensores del grupo. \end{DoxyCompactList}\item 
void \textbf{ inicializar\+\_\+mi\+\_\+simulacion\+\_\+ascensor} (void)
\begin{DoxyCompactList}\small\item\em Inicializa el simulador de ascensores. \end{DoxyCompactList}\item 
void \textbf{ simular\+\_\+eventos\+\_\+ascensor} (void)
\begin{DoxyCompactList}\small\item\em Ejecuta una secuencia de eventos simulados de ascensor desde JSON. \end{DoxyCompactList}\item 
static int \textbf{ event\+\_\+handler\+\_\+gw} (coap\+\_\+session\+\_\+t $\ast$session, coap\+\_\+event\+\_\+t event)
\begin{DoxyCompactList}\small\item\em Manejador de eventos Co\+AP para sesiones DTLS. \end{DoxyCompactList}\item 
coap\+\_\+session\+\_\+t $\ast$ \textbf{ get\+\_\+or\+\_\+create\+\_\+central\+\_\+server\+\_\+dtls\+\_\+session} (coap\+\_\+context\+\_\+t $\ast$ctx)
\begin{DoxyCompactList}\small\item\em Obtiene o crea una sesión DTLS con el servidor central. \end{DoxyCompactList}\item 
int \textbf{ main} (int argc, char $\ast$argv[$\,$])
\begin{DoxyCompactList}\small\item\em Main function for the API Gateway. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
volatile sig\+\_\+atomic\+\_\+t \textbf{ quit\+\_\+main\+\_\+loop} = 0
\begin{DoxyCompactList}\small\item\em Bandera global para controlar el bucle principal de la aplicación. \end{DoxyCompactList}\item 
\textbf{ elevator\+\_\+group\+\_\+state\+\_\+t} \textbf{ managed\+\_\+elevator\+\_\+group}
\begin{DoxyCompactList}\small\item\em Estado global del grupo de ascensores gestionado por este gateway. \end{DoxyCompactList}\item 
coap\+\_\+context\+\_\+t $\ast$ \textbf{ g\+\_\+coap\+\_\+context} = NULL
\begin{DoxyCompactList}\small\item\em Contexto Co\+AP global para la simulación y gestión de sesiones. \end{DoxyCompactList}\item 
coap\+\_\+session\+\_\+t $\ast$ \textbf{ g\+\_\+dtls\+\_\+session\+\_\+to\+\_\+central\+\_\+server} = NULL
\begin{DoxyCompactList}\small\item\em Sesión DTLS global con el servidor central. \end{DoxyCompactList}\item 
static coap\+\_\+context\+\_\+t $\ast$ \textbf{ g\+\_\+coap\+\_\+context\+\_\+for\+\_\+session\+\_\+mgnt} = NULL
\begin{DoxyCompactList}\small\item\em Contexto Co\+AP para la gestión de sesiones DTLS. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Punto de entrada principal del API Gateway del Sistema de Control de Ascensores. 

\begin{DoxyAuthor}{Author}
Sistema de Control de Ascensores 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
2025 
\end{DoxyDate}
\begin{DoxyVersion}{Version}
2.\+0
\end{DoxyVersion}
Este archivo implementa el API Gateway que actúa como intermediario entre los controladores CAN de ascensores y el servidor central. Sus funciones principales\+:


\begin{DoxyItemize}
\item {\bfseries{Inicialización Co\+AP}}\+: Configuración del contexto Co\+AP con soporte DTLS-\/\+PSK
\item {\bfseries{Gestión de Recursos}}\+: Registro de endpoints Co\+AP para recibir solicitudes
\item {\bfseries{Puente CAN-\/\+Co\+AP}}\+: Transformación de mensajes CAN a solicitudes Co\+AP
\item {\bfseries{Gestión de Estado}}\+: Mantenimiento del estado local de ascensores
\item {\bfseries{Comunicación Segura}}\+: Establecimiento de sesiones DTLS con servidor central
\item {\bfseries{Simulación}}\+: Simulación de movimiento de ascensores para testing
\item {\bfseries{Manejo de Señales}}\+: Terminación elegante con SIGINT
\end{DoxyItemize}

El gateway procesa dos tipos principales de solicitudes\+:
\begin{DoxyItemize}
\item Llamadas de piso (floor calls) desde botones externos
\item Solicitudes de cabina (cabin requests) desde interior del ascensor
\end{DoxyItemize}

\begin{DoxySeeAlso}{See also}
api\+\_\+handlers.\+h 

\doxyref{elevator\+\_\+state\+\_\+manager.\+h}{p.}{elevator__state__manager_8h} 

\doxyref{can\+\_\+bridge.\+h}{p.}{can__bridge_8h} 

\doxyref{coap\+\_\+config.\+h}{p.}{coap__config_8h} 
\end{DoxySeeAlso}


\doxysubsection{Function Documentation}
\label{main_8c_a4d72c24b61707ff5f39a4123ca8cd833} 
\index{main.c@{main.c}!event\_handler\_gw@{event\_handler\_gw}}
\index{event\_handler\_gw@{event\_handler\_gw}!main.c@{main.c}}
\doxysubsubsection{event\_handler\_gw()}
{\footnotesize\ttfamily static int event\+\_\+handler\+\_\+gw (\begin{DoxyParamCaption}\item[{coap\+\_\+session\+\_\+t $\ast$}]{session,  }\item[{coap\+\_\+event\+\_\+t}]{event }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Manejador de eventos Co\+AP para sesiones DTLS. 


\begin{DoxyParams}{Parameters}
{\em session} & Sesión Co\+AP que generó el evento \\
\hline
{\em event} & Tipo de evento ocurrido \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
0 si el evento se procesó correctamente
\end{DoxyReturn}
Esta función maneja eventos relacionados con sesiones DTLS, especialmente cierres de conexión y errores. Limpia automáticamente la sesión global cuando se detecta que se ha cerrado o ha fallado.

Eventos manejados\+:
\begin{DoxyItemize}
\item COAP\+\_\+\+EVENT\+\_\+\+DTLS\+\_\+\+CLOSED\+: Sesión DTLS cerrada
\item COAP\+\_\+\+EVENT\+\_\+\+DTLS\+\_\+\+ERROR\+: Error en sesión DTLS
\item COAP\+\_\+\+EVENT\+\_\+\+SESSION\+\_\+\+CLOSED\+: Sesión cerrada
\item COAP\+\_\+\+EVENT\+\_\+\+SESSION\+\_\+\+FAILED\+: Sesión falló 
\end{DoxyItemize}\label{main_8c_aaab19c59907fdd4643b33b5056420f9b} 
\index{main.c@{main.c}!generate\_unique\_identity@{generate\_unique\_identity}}
\index{generate\_unique\_identity@{generate\_unique\_identity}!main.c@{main.c}}
\doxysubsubsection{generate\_unique\_identity()}
{\footnotesize\ttfamily static char $\ast$ generate\+\_\+unique\+\_\+identity (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}

\label{main_8c_a7deba370f74d01d89ecd93cb376b1873} 
\index{main.c@{main.c}!generate\_unique\_psk\_key@{generate\_unique\_psk\_key}}
\index{generate\_unique\_psk\_key@{generate\_unique\_psk\_key}!main.c@{main.c}}
\doxysubsubsection{generate\_unique\_psk\_key()}
{\footnotesize\ttfamily static char $\ast$ generate\+\_\+unique\+\_\+psk\+\_\+key (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}

\label{main_8c_a7910799dc4997ea7ff42bb0339134d94} 
\index{main.c@{main.c}!get\_or\_create\_central\_server\_dtls\_session@{get\_or\_create\_central\_server\_dtls\_session}}
\index{get\_or\_create\_central\_server\_dtls\_session@{get\_or\_create\_central\_server\_dtls\_session}!main.c@{main.c}}
\doxysubsubsection{get\_or\_create\_central\_server\_dtls\_session()}
{\footnotesize\ttfamily coap\+\_\+session\+\_\+t $\ast$ get\+\_\+or\+\_\+create\+\_\+central\+\_\+server\+\_\+dtls\+\_\+session (\begin{DoxyParamCaption}\item[{coap\+\_\+context\+\_\+t $\ast$}]{ctx }\end{DoxyParamCaption})}



Obtiene o crea una sesión DTLS con el servidor central. 


\begin{DoxyParams}{Parameters}
{\em ctx} & Contexto Co\+AP a utilizar para la sesión \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Puntero a la sesión DTLS establecida, o NULL en caso de error
\end{DoxyReturn}
Esta función implementa un patrón singleton para la gestión de sesiones DTLS con el servidor central. Reutiliza sesiones existentes cuando están activas y crea nuevas sesiones cuando es necesario.

Comportamiento\+:
\begin{DoxyEnumerate}
\item Si existe una sesión activa y establecida, la reutiliza
\item Si la sesión existe pero no está establecida, la libera y crea una nueva
\item Si no existe sesión, crea una nueva con configuración DTLS-\/\+PSK
\item Registra el manejador de eventos para gestión automática de la sesión
\end{DoxyEnumerate}

La función utiliza las siguientes configuraciones\+:
\begin{DoxyItemize}
\item IP del servidor\+: CENTRAL\+\_\+\+SERVER\+\_\+\+IP
\item Puerto del servidor\+: CENTRAL\+\_\+\+SERVER\+\_\+\+PORT ~\newline

\item Identidad PSK\+: IDENTITY\+\_\+\+TO\+\_\+\+PRESENT\+\_\+\+TO\+\_\+\+SERVER
\item Clave PSK\+: KEY\+\_\+\+FOR\+\_\+\+SERVER
\end{DoxyItemize}

\begin{DoxySeeAlso}{See also}
\doxyref{event\+\_\+handler\+\_\+gw()}{p.}{main_8c_a4d72c24b61707ff5f39a4123ca8cd833} 

\doxyref{coap\+\_\+config.\+h}{p.}{coap__config_8h} 
\end{DoxySeeAlso}
\label{main_8c_acfc4758bf8842f413c4d9e1c5ce6053d} 
\index{main.c@{main.c}!inicializar\_mi\_simulacion\_ascensor@{inicializar\_mi\_simulacion\_ascensor}}
\index{inicializar\_mi\_simulacion\_ascensor@{inicializar\_mi\_simulacion\_ascensor}!main.c@{main.c}}
\doxysubsubsection{inicializar\_mi\_simulacion\_ascensor()}
{\footnotesize\ttfamily void inicializar\+\_\+mi\+\_\+simulacion\+\_\+ascensor (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Inicializa el simulador de ascensores. 

Esta función configura el simulador registrando el callback de respuesta CAN en el puente CAN-\/\+Co\+AP del API Gateway y cargando los datos de simulación desde el archivo JSON.

{\bfseries{Operaciones realizadas\+:}}
\begin{DoxyItemize}
\item Registro del callback de respuesta CAN
\item Carga de datos de simulación desde JSON
\item Inicialización de estructuras internas
\item Configuración de logging del simulador
\end{DoxyItemize}

\begin{DoxySeeAlso}{See also}
\doxyref{ag\+\_\+can\+\_\+bridge\+\_\+register\+\_\+send\+\_\+callback()}{p.}{can__bridge_8c_a82b3383904e65573e79b59f4b7c5ef15} 

\doxyref{cargar\+\_\+datos\+\_\+simulacion()}{p.}{group__simulation__functions_ga189a79642cdf0001b3a29062e4180af3} 

\doxyref{mi\+\_\+simulador\+\_\+recibe\+\_\+can\+\_\+gw()}{p.}{mi__simulador__ascensor_8c_adfcf33ff0806b77c246bbd870b029566} 
\end{DoxySeeAlso}
\label{main_8c_a0ddf1224851353fc92bfbff6f499fa97} 
\index{main.c@{main.c}!main@{main}}
\index{main@{main}!main.c@{main.c}}
\doxysubsubsection{main()}
{\footnotesize\ttfamily int main (\begin{DoxyParamCaption}\item[{int}]{argc,  }\item[{char $\ast$}]{argv[$\,$] }\end{DoxyParamCaption})}



Main function for the API Gateway. 

Initializes libcoap, sets up the Co\+AP server endpoint for listening to elevator clients, registers Co\+AP resource handlers, and enters the main I/O processing loop. The gateway listens for client requests, forwards them to a central server, and relays responses back to the clients.


\begin{DoxyParams}{Parameters}
{\em argc} & Número de argumentos de línea de comandos \\
\hline
{\em argv} & Array de argumentos de línea de comandos argv[1] (opcional)\+: Puerto de escucha (por defecto usa GW\+\_\+\+LISTEN\+\_\+\+PORT)\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
EXIT\+\_\+\+SUCCESS on successful execution and shutdown, EXIT\+\_\+\+FAILURE on error. 
\end{DoxyReturn}
\label{main_8c_a5c86f739de835826e9fa6dd607c52ec9} 
\index{main.c@{main.c}!simular\_eventos\_ascensor@{simular\_eventos\_ascensor}}
\index{simular\_eventos\_ascensor@{simular\_eventos\_ascensor}!main.c@{main.c}}
\doxysubsubsection{simular\_eventos\_ascensor()}
{\footnotesize\ttfamily void simular\+\_\+eventos\+\_\+ascensor (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Ejecuta una secuencia de eventos simulados de ascensor desde JSON. 

Esta función reemplaza la simulación hardcodeada anterior. Ahora carga datos de simulación desde un archivo JSON, selecciona un edificio aleatorio y ejecuta todas sus peticiones secuencialmente.

{\bfseries{Proceso de simulación\+:}}
\begin{DoxyEnumerate}
\item Verifica si hay datos de simulación cargados
\item Selecciona un edificio aleatorio de los 100 disponibles
\item Configura el ID del edificio en el sistema
\item Ejecuta las 10 peticiones del edificio secuencialmente
\item Procesa I/O Co\+AP entre cada petición
\end{DoxyEnumerate}

{\bfseries{Fallback\+:}} Si no se pueden cargar los datos JSON, ejecuta la simulación básica de 2 peticiones hardcodeadas como antes.

{\bfseries{Características\+:}}
\begin{DoxyItemize}
\item Procesamiento de I/O Co\+AP entre eventos
\item Logging detallado de cada paso
\item Sincronización para evitar condiciones de carrera
\item Configuración automática del ID de edificio
\end{DoxyItemize}

\begin{DoxySeeAlso}{See also}
\doxyref{cargar\+\_\+datos\+\_\+simulacion()}{p.}{group__simulation__functions_ga189a79642cdf0001b3a29062e4180af3} 

\doxyref{seleccionar\+\_\+edificio\+\_\+aleatorio()}{p.}{group__simulation__functions_ga87620ad51d06f241a3106a36c40ac787} 

\doxyref{simular\+\_\+llamada\+\_\+de\+\_\+piso\+\_\+via\+\_\+can()}{p.}{mi__simulador__ascensor_8c_ad2f8184c447385d5155da6a8d87e6c16} 

\doxyref{simular\+\_\+solicitud\+\_\+cabina\+\_\+via\+\_\+can()}{p.}{mi__simulador__ascensor_8c_a75bd27a88662d9e2ac061e5285fc7ecb} 

coap\+\_\+io\+\_\+process() 
\end{DoxySeeAlso}
\label{main_8c_af318206d98c90d1ed8b33a0f564ad219} 
\index{main.c@{main.c}!simulate\_elevator\_group\_step@{simulate\_elevator\_group\_step}}
\index{simulate\_elevator\_group\_step@{simulate\_elevator\_group\_step}!main.c@{main.c}}
\doxysubsubsection{simulate\_elevator\_group\_step()}
{\footnotesize\ttfamily static void simulate\+\_\+elevator\+\_\+group\+\_\+step (\begin{DoxyParamCaption}\item[{coap\+\_\+context\+\_\+t $\ast$}]{ctx,  }\item[{\textbf{ elevator\+\_\+group\+\_\+state\+\_\+t} $\ast$}]{group }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Simula un paso de movimiento para todos los ascensores del grupo. 


\begin{DoxyParams}{Parameters}
{\em ctx} & Contexto Co\+AP para logging y operaciones \\
\hline
{\em group} & Grupo de ascensores a simular\\
\hline
\end{DoxyParams}
Esta función implementa la lógica de simulación de movimiento de ascensores. Se ejecuta periódicamente para actualizar el estado de todos los ascensores que tienen tareas asignadas.

Funcionalidades implementadas\+:
\begin{DoxyItemize}
\item {\bfseries{Cierre de puertas}}\+: Cierra puertas antes del movimiento
\item {\bfseries{Determinación de dirección}}\+: Calcula dirección basada en destino
\item {\bfseries{Simulación de movimiento}}\+: Mueve ascensores piso por piso
\item {\bfseries{Detección de llegada}}\+: Detecta cuando un ascensor llega a su destino
\item {\bfseries{Completado de tareas}}\+: Notifica llegadas y libera ascensores
\end{DoxyItemize}

La simulación maneja los siguientes estados\+:
\begin{DoxyItemize}
\item Ascensores ocupados con destino válido
\item Movimiento hacia arriba (MOVING\+\_\+\+UP)
\item Movimiento hacia abajo (MOVING\+\_\+\+DOWN)
\item Llegada a destino y liberación
\end{DoxyItemize}

\begin{DoxySeeAlso}{See also}
\doxyref{elevator\+\_\+group\+\_\+state\+\_\+t}{p.}{structelevator__group__state__t} 

\doxyref{elevator\+\_\+status\+\_\+t}{p.}{structelevator__status__t} 
\end{DoxySeeAlso}


\doxysubsection{Variable Documentation}
\label{main_8c_abc8b9aeba00fbf6aeb7c811c034f383c} 
\index{main.c@{main.c}!g\_coap\_context@{g\_coap\_context}}
\index{g\_coap\_context@{g\_coap\_context}!main.c@{main.c}}
\doxysubsubsection{g\_coap\_context}
{\footnotesize\ttfamily coap\+\_\+context\+\_\+t$\ast$ g\+\_\+coap\+\_\+context = NULL}



Contexto Co\+AP global para la simulación y gestión de sesiones. 

Contexto Co\+AP global del API Gateway.

Contexto principal utilizado para todas las operaciones Co\+AP, incluyendo la simulación de ascensores y la gestión de sesiones DTLS. \label{main_8c_a003791cd6468260e13e2f2fd719e9fe4} 
\index{main.c@{main.c}!g\_coap\_context\_for\_session\_mgnt@{g\_coap\_context\_for\_session\_mgnt}}
\index{g\_coap\_context\_for\_session\_mgnt@{g\_coap\_context\_for\_session\_mgnt}!main.c@{main.c}}
\doxysubsubsection{g\_coap\_context\_for\_session\_mgnt}
{\footnotesize\ttfamily coap\+\_\+context\+\_\+t$\ast$ g\+\_\+coap\+\_\+context\+\_\+for\+\_\+session\+\_\+mgnt = NULL\hspace{0.3cm}{\ttfamily [static]}}



Contexto Co\+AP para la gestión de sesiones DTLS. 

Contexto específico utilizado para el manejo de eventos de sesiones DTLS con el servidor central. \label{main_8c_abe546e2cc7517fb0f6e0218ca1e3ff10} 
\index{main.c@{main.c}!g\_dtls\_session\_to\_central\_server@{g\_dtls\_session\_to\_central\_server}}
\index{g\_dtls\_session\_to\_central\_server@{g\_dtls\_session\_to\_central\_server}!main.c@{main.c}}
\doxysubsubsection{g\_dtls\_session\_to\_central\_server}
{\footnotesize\ttfamily coap\+\_\+session\+\_\+t$\ast$ g\+\_\+dtls\+\_\+session\+\_\+to\+\_\+central\+\_\+server = NULL}



Sesión DTLS global con el servidor central. 

Mantiene la conexión segura DTLS-\/\+PSK con el servidor central para el envío de solicitudes de asignación de ascensores. Se reutiliza para múltiples solicitudes para eficiencia. \label{main_8c_a2e69b946477ed035db425886fe261a13} 
\index{main.c@{main.c}!managed\_elevator\_group@{managed\_elevator\_group}}
\index{managed\_elevator\_group@{managed\_elevator\_group}!main.c@{main.c}}
\doxysubsubsection{managed\_elevator\_group}
{\footnotesize\ttfamily \textbf{ elevator\+\_\+group\+\_\+state\+\_\+t} managed\+\_\+elevator\+\_\+group}



Estado global del grupo de ascensores gestionado por este gateway. 

Grupo de ascensores gestionado.

Estado del grupo de ascensores gestionado.

Estado del grupo de ascensores gestionado por este gateway.

Contiene el estado completo de todos los ascensores del edificio gestionado por este API Gateway, incluyendo posiciones actuales, tareas asignadas, estados de puertas y disponibilidad.

\begin{DoxySeeAlso}{See also}
\doxyref{elevator\+\_\+group\+\_\+state\+\_\+t}{p.}{structelevator__group__state__t} 

\doxyref{elevator\+\_\+state\+\_\+manager.\+h}{p.}{elevator__state__manager_8h} 
\end{DoxySeeAlso}
\label{main_8c_a8a485bed3bbf69f7556aa3167043d7e2} 
\index{main.c@{main.c}!quit\_main\_loop@{quit\_main\_loop}}
\index{quit\_main\_loop@{quit\_main\_loop}!main.c@{main.c}}
\doxysubsubsection{quit\_main\_loop}
{\footnotesize\ttfamily volatile sig\+\_\+atomic\+\_\+t quit\+\_\+main\+\_\+loop = 0}



Bandera global para controlar el bucle principal de la aplicación. 

Bandera para indicar si el bucle principal debe terminar.

Esta bandera se establece a 1 por el manejador de señal SIGINT (handle\+\_\+sigint\+\_\+gw) para indicar que la aplicación debe terminar de manera elegante.

\begin{DoxySeeAlso}{See also}
\doxyref{handle\+\_\+sigint\+\_\+gw()}{p.}{api__handlers_8c_a7fd01dcda5b603f45f20d97c84d9260b} 
\end{DoxySeeAlso}
