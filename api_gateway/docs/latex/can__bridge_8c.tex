\doxysection{src/can\+\_\+bridge.c File Reference}
\hypertarget{can__bridge_8c}{}\label{can__bridge_8c}\index{src/can\_bridge.c@{src/can\_bridge.c}}


Implementación del Puente CAN-\/\+Co\+AP para el API Gateway.  


{\ttfamily \#include "{}api\+\_\+gateway/can\+\_\+bridge.\+h"{}}\newline
{\ttfamily \#include "{}api\+\_\+gateway/api\+\_\+handlers.\+h"{}}\newline
{\ttfamily \#include "{}api\+\_\+gateway/elevator\+\_\+state\+\_\+manager.\+h"{}}\newline
{\ttfamily \#include "{}api\+\_\+gateway/execution\+\_\+logger.\+h"{}}\newline
{\ttfamily \#include $<$coap3/coap.\+h$>$}\newline
{\ttfamily \#include $<$stdio.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include $<$stdlib.\+h$>$}\newline
{\ttfamily \#include $<$arpa/inet.\+h$>$}\newline
Include dependency graph for can\+\_\+bridge.\+c\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{can__bridge_8c__incl}
\end{center}
\end{figure}
\doxysubsubsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \mbox{\hyperlink{can__bridge_8c_a343d6dfea37d0b7cd2c6dcbe87b4899c}{CAN\+\_\+\+MAX\+\_\+\+DATA\+\_\+\+LEN}}~8
\begin{DoxyCompactList}\small\item\em Longitud máxima de datos en un frame CAN estándar. \end{DoxyCompactList}\item 
\#define \mbox{\hyperlink{can__bridge_8c_a9e4f7e8f9637a799aeaedf07bcb61c08}{MAX\+\_\+\+CAN\+\_\+\+ORIGIN\+\_\+\+TRACKERS}}~10
\begin{DoxyCompactList}\small\item\em Número máximo de trackers CAN simultáneos. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
can\+\_\+origin\+\_\+tracker\+\_\+t \texorpdfstring{$\ast$}{*} \mbox{\hyperlink{can__bridge_8c_a7027a900f632b8023cfd9f3b0e4a5a99}{find\+\_\+can\+\_\+tracker}} (coap\+\_\+bin\+\_\+const\+\_\+t token)
\begin{DoxyCompactList}\small\item\em Busca un tracker CAN por token Co\+AP. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{can__bridge_8c_a331e50c4b7681888fa7b0c1eb89e7f32}{ag\+\_\+can\+\_\+bridge\+\_\+init}} (void)
\begin{DoxyCompactList}\small\item\em Inicializa el puente CAN-\/\+Co\+AP. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{can__bridge_8c_a82b3383904e65573e79b59f4b7c5ef15}{ag\+\_\+can\+\_\+bridge\+\_\+register\+\_\+send\+\_\+callback}} (can\+\_\+send\+\_\+callback\+\_\+t callback)
\begin{DoxyCompactList}\small\item\em Registra el callback para envío de frames CAN al simulador. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{can__bridge_8c_aacea58e11d63ec4a2601d1b225af2af7}{ag\+\_\+can\+\_\+bridge\+\_\+process\+\_\+incoming\+\_\+frame}} (simulated\+\_\+can\+\_\+frame\+\_\+t \texorpdfstring{$\ast$}{*}frame, coap\+\_\+context\+\_\+t \texorpdfstring{$\ast$}{*}coap\+\_\+ctx)
\begin{DoxyCompactList}\small\item\em Procesa un frame CAN entrante y lo convierte a solicitud Co\+AP. \end{DoxyCompactList}\item 
\Hypertarget{can__bridge_8c_a5add34ce57a2d36aa902cf08b921a665}\label{can__bridge_8c_a5add34ce57a2d36aa902cf08b921a665} 
void {\bfseries ag\+\_\+can\+\_\+bridge\+\_\+send\+\_\+response\+\_\+frame} (uint32\+\_\+t original\+\_\+can\+\_\+id, coap\+\_\+pdu\+\_\+code\+\_\+t response\+\_\+code, c\+JSON \texorpdfstring{$\ast$}{*}server\+\_\+response\+\_\+json)
\begin{DoxyCompactList}\small\item\em Envía una respuesta (traducida de Co\+AP) como un frame CAN simulado a la simulación. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
elevator\+\_\+group\+\_\+state\+\_\+t \mbox{\hyperlink{can__bridge_8c_a2e69b946477ed035db425886fe261a13}{managed\+\_\+elevator\+\_\+group}}
\begin{DoxyCompactList}\small\item\em Estado del grupo de ascensores gestionado. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Implementación del Puente CAN-\/\+Co\+AP para el API Gateway. 

\begin{DoxyAuthor}{Author}
Sistema de Control de Ascensores 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
2025 
\end{DoxyDate}
\begin{DoxyVersion}{Version}
2.\+0
\end{DoxyVersion}
Este archivo implementa el puente de comunicación entre el protocolo CAN (Controller Area Network) y Co\+AP (Constrained Application Protocol) para el sistema de control de ascensores. Sus funciones principales\+:


\begin{DoxyItemize}
\item {\bfseries{Procesamiento de frames CAN}}\+: Interpretación de mensajes CAN entrantes
\item {\bfseries{Conversión CAN-\/\+Co\+AP}}\+: Transformación de solicitudes CAN a Co\+AP
\item {\bfseries{Gestión de trackers}}\+: Seguimiento de solicitudes originadas por CAN
\item {\bfseries{Respuestas CAN}}\+: Envío de respuestas del servidor central vía CAN
\item {\bfseries{Simulación}}\+: Interfaz con simulador de red CAN para testing
\item {\bfseries{Logging}}\+: Registro detallado de operaciones para debugging
\end{DoxyItemize}

Tipos de mensajes CAN soportados\+:
\begin{DoxyItemize}
\item {\bfseries{0x100}}\+: Llamadas de piso (floor calls) con dirección
\item {\bfseries{0x200}}\+: Solicitudes de cabina (cabin requests) con destino
\item {\bfseries{0x300}}\+: Notificaciones de llegada de ascensores
\end{DoxyItemize}

El puente mantiene un buffer circular de trackers para correlacionar respuestas del servidor central con las solicitudes CAN originales.

\begin{DoxySeeAlso}{See also}
can\+\_\+bridge.\+h 

\doxylink{api__handlers_8h}{api\+\_\+handlers.\+h} 

elevator\+\_\+state\+\_\+manager.\+h 

coap\+\_\+config.\+h 
\end{DoxySeeAlso}


\doxysubsection{Macro Definition Documentation}
\Hypertarget{can__bridge_8c_a343d6dfea37d0b7cd2c6dcbe87b4899c}\label{can__bridge_8c_a343d6dfea37d0b7cd2c6dcbe87b4899c} 
\index{can\_bridge.c@{can\_bridge.c}!CAN\_MAX\_DATA\_LEN@{CAN\_MAX\_DATA\_LEN}}
\index{CAN\_MAX\_DATA\_LEN@{CAN\_MAX\_DATA\_LEN}!can\_bridge.c@{can\_bridge.c}}
\doxysubsubsection{\texorpdfstring{CAN\_MAX\_DATA\_LEN}{CAN\_MAX\_DATA\_LEN}}
{\footnotesize\ttfamily \#define CAN\+\_\+\+MAX\+\_\+\+DATA\+\_\+\+LEN~8}



Longitud máxima de datos en un frame CAN estándar. 

Define el número máximo de bytes de datos que puede contener un frame CAN estándar según la especificación CAN 2.\+0. \Hypertarget{can__bridge_8c_a9e4f7e8f9637a799aeaedf07bcb61c08}\label{can__bridge_8c_a9e4f7e8f9637a799aeaedf07bcb61c08} 
\index{can\_bridge.c@{can\_bridge.c}!MAX\_CAN\_ORIGIN\_TRACKERS@{MAX\_CAN\_ORIGIN\_TRACKERS}}
\index{MAX\_CAN\_ORIGIN\_TRACKERS@{MAX\_CAN\_ORIGIN\_TRACKERS}!can\_bridge.c@{can\_bridge.c}}
\doxysubsubsection{\texorpdfstring{MAX\_CAN\_ORIGIN\_TRACKERS}{MAX\_CAN\_ORIGIN\_TRACKERS}}
{\footnotesize\ttfamily \#define MAX\+\_\+\+CAN\+\_\+\+ORIGIN\+\_\+\+TRACKERS~10}



Número máximo de trackers CAN simultáneos. 

Define el tamaño del buffer circular utilizado para almacenar información de solicitudes originadas por CAN que están pendientes de respuesta del servidor central. 

\doxysubsection{Function Documentation}
\Hypertarget{can__bridge_8c_a331e50c4b7681888fa7b0c1eb89e7f32}\label{can__bridge_8c_a331e50c4b7681888fa7b0c1eb89e7f32} 
\index{can\_bridge.c@{can\_bridge.c}!ag\_can\_bridge\_init@{ag\_can\_bridge\_init}}
\index{ag\_can\_bridge\_init@{ag\_can\_bridge\_init}!can\_bridge.c@{can\_bridge.c}}
\doxysubsubsection{\texorpdfstring{ag\_can\_bridge\_init()}{ag\_can\_bridge\_init()}}
{\footnotesize\ttfamily void ag\+\_\+can\+\_\+bridge\+\_\+init (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Inicializa el puente CAN-\/\+Co\+AP. 

Esta función inicializa el sistema de puente CAN-\/\+Co\+AP, preparando todas las estructuras de datos necesarias para el funcionamiento.

Operaciones realizadas\+:
\begin{DoxyItemize}
\item Limpia el callback de envío CAN
\item Libera memoria de tokens almacenados en trackers
\item Inicializa a cero el buffer de trackers CAN
\item Resetea el índice del buffer circular
\end{DoxyItemize}

Debe llamarse una vez al inicio del programa antes de procesar cualquier frame CAN o registrar callbacks.

\begin{DoxySeeAlso}{See also}
\doxylink{can__bridge_8c_a82b3383904e65573e79b59f4b7c5ef15}{ag\+\_\+can\+\_\+bridge\+\_\+register\+\_\+send\+\_\+callback()} 

\doxylink{can__bridge_8c_aacea58e11d63ec4a2601d1b225af2af7}{ag\+\_\+can\+\_\+bridge\+\_\+process\+\_\+incoming\+\_\+frame()} 
\end{DoxySeeAlso}
\Hypertarget{can__bridge_8c_aacea58e11d63ec4a2601d1b225af2af7}\label{can__bridge_8c_aacea58e11d63ec4a2601d1b225af2af7} 
\index{can\_bridge.c@{can\_bridge.c}!ag\_can\_bridge\_process\_incoming\_frame@{ag\_can\_bridge\_process\_incoming\_frame}}
\index{ag\_can\_bridge\_process\_incoming\_frame@{ag\_can\_bridge\_process\_incoming\_frame}!can\_bridge.c@{can\_bridge.c}}
\doxysubsubsection{\texorpdfstring{ag\_can\_bridge\_process\_incoming\_frame()}{ag\_can\_bridge\_process\_incoming\_frame()}}
{\footnotesize\ttfamily void ag\+\_\+can\+\_\+bridge\+\_\+process\+\_\+incoming\+\_\+frame (\begin{DoxyParamCaption}\item[{simulated\+\_\+can\+\_\+frame\+\_\+t \texorpdfstring{$\ast$}{*}}]{frame,  }\item[{coap\+\_\+context\+\_\+t \texorpdfstring{$\ast$}{*}}]{coap\+\_\+ctx }\end{DoxyParamCaption})}



Procesa un frame CAN entrante y lo convierte a solicitud Co\+AP. 


\begin{DoxyParams}{Parameters}
{\em frame} & Puntero al frame CAN simulado a procesar \\
\hline
{\em coap\+\_\+ctx} & Contexto Co\+AP para enviar solicitudes al servidor central\\
\hline
\end{DoxyParams}
Esta función es el punto de entrada principal para el procesamiento de frames CAN entrantes. Interpreta el contenido del frame según el esquema de mensajes CAN definido y genera las solicitudes Co\+AP correspondientes al servidor central.

{\bfseries{Tipos de frames CAN soportados\+:}}
\begin{DoxyItemize}
\item {\bfseries{0x100 -\/ Llamada de piso}}\+:
\begin{DoxyItemize}
\item data\mbox{[}0\mbox{]}\+: Piso origen (0-\/255)
\item data\mbox{[}1\mbox{]}\+: Dirección (0=UP, 1=DOWN)
\end{DoxyItemize}
\item {\bfseries{0x200 -\/ Solicitud de cabina}}\+:
\begin{DoxyItemize}
\item data\mbox{[}0\mbox{]}\+: Índice del ascensor (0-\/based)
\item data\mbox{[}1\mbox{]}\+: Piso destino (0-\/255)
\end{DoxyItemize}
\item {\bfseries{0x300 -\/ Notificación de llegada}}\+:
\begin{DoxyItemize}
\item data\mbox{[}0\mbox{]}\+: Índice del ascensor (0-\/based)
\item data\mbox{[}1\mbox{]}\+: Piso actual (0-\/255)
\end{DoxyItemize}
\end{DoxyItemize}

Para cada frame válido, la función\+:
\begin{DoxyEnumerate}
\item Valida el formato y longitud de datos
\item Extrae los parámetros específicos del tipo de mensaje
\item Genera una solicitud Co\+AP al servidor central
\item Almacena un tracker para correlacionar la respuesta
\end{DoxyEnumerate}

\begin{DoxyNote}{Note}
Los IDs CAN y formato de datos deben adaptarse según el esquema específico del sistema de ascensores
\end{DoxyNote}
\begin{DoxySeeAlso}{See also}
forward\+\_\+can\+\_\+originated\+\_\+request\+\_\+to\+\_\+central\+\_\+server() 

store\+\_\+can\+\_\+tracker() 

simulated\+\_\+can\+\_\+frame\+\_\+t 
\end{DoxySeeAlso}
\Hypertarget{can__bridge_8c_a82b3383904e65573e79b59f4b7c5ef15}\label{can__bridge_8c_a82b3383904e65573e79b59f4b7c5ef15} 
\index{can\_bridge.c@{can\_bridge.c}!ag\_can\_bridge\_register\_send\_callback@{ag\_can\_bridge\_register\_send\_callback}}
\index{ag\_can\_bridge\_register\_send\_callback@{ag\_can\_bridge\_register\_send\_callback}!can\_bridge.c@{can\_bridge.c}}
\doxysubsubsection{\texorpdfstring{ag\_can\_bridge\_register\_send\_callback()}{ag\_can\_bridge\_register\_send\_callback()}}
{\footnotesize\ttfamily void ag\+\_\+can\+\_\+bridge\+\_\+register\+\_\+send\+\_\+callback (\begin{DoxyParamCaption}\item[{can\+\_\+send\+\_\+callback\+\_\+t}]{callback }\end{DoxyParamCaption})}



Registra el callback para envío de frames CAN al simulador. 


\begin{DoxyParams}{Parameters}
{\em callback} & Función callback que será llamada para enviar frames CAN\\
\hline
\end{DoxyParams}
Esta función registra una función callback que será utilizada por el puente CAN-\/\+Co\+AP para enviar frames CAN de respuesta al simulador.

El callback debe implementar la interfaz can\+\_\+send\+\_\+callback\+\_\+t y será invocado cuando el puente necesite enviar respuestas del servidor central de vuelta al sistema CAN simulado.

\begin{DoxyNote}{Note}
Solo se puede registrar un callback a la vez. Llamadas posteriores sobrescriben el callback anterior.
\end{DoxyNote}
\begin{DoxySeeAlso}{See also}
can\+\_\+send\+\_\+callback\+\_\+t 

\doxylink{can__bridge_8c_a5add34ce57a2d36aa902cf08b921a665}{ag\+\_\+can\+\_\+bridge\+\_\+send\+\_\+response\+\_\+frame()} 
\end{DoxySeeAlso}
\Hypertarget{can__bridge_8c_a7027a900f632b8023cfd9f3b0e4a5a99}\label{can__bridge_8c_a7027a900f632b8023cfd9f3b0e4a5a99} 
\index{can\_bridge.c@{can\_bridge.c}!find\_can\_tracker@{find\_can\_tracker}}
\index{find\_can\_tracker@{find\_can\_tracker}!can\_bridge.c@{can\_bridge.c}}
\doxysubsubsection{\texorpdfstring{find\_can\_tracker()}{find\_can\_tracker()}}
{\footnotesize\ttfamily can\+\_\+origin\+\_\+tracker\+\_\+t \texorpdfstring{$\ast$}{*} find\+\_\+can\+\_\+tracker (\begin{DoxyParamCaption}\item[{coap\+\_\+bin\+\_\+const\+\_\+t}]{token }\end{DoxyParamCaption})}



Busca un tracker CAN por token Co\+AP. 


\begin{DoxyParams}{Parameters}
{\em token} & Token Co\+AP a buscar en los trackers almacenados \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Puntero al tracker encontrado, o NULL si no se encuentra
\end{DoxyReturn}
Esta función busca en el buffer circular de trackers CAN un tracker que corresponda al token Co\+AP especificado. Se utiliza para correlacionar respuestas del servidor central con solicitudes CAN originales.

La búsqueda se realiza comparando tanto la longitud como el contenido binario del token. No remueve el tracker de la lista (a diferencia de find\+\_\+and\+\_\+remove\+\_\+central\+\_\+request\+\_\+tracker).

\begin{DoxySeeAlso}{See also}
store\+\_\+can\+\_\+tracker() 

can\+\_\+origin\+\_\+tracker\+\_\+t 
\end{DoxySeeAlso}


\doxysubsection{Variable Documentation}
\Hypertarget{can__bridge_8c_a2e69b946477ed035db425886fe261a13}\label{can__bridge_8c_a2e69b946477ed035db425886fe261a13} 
\index{can\_bridge.c@{can\_bridge.c}!managed\_elevator\_group@{managed\_elevator\_group}}
\index{managed\_elevator\_group@{managed\_elevator\_group}!can\_bridge.c@{can\_bridge.c}}
\doxysubsubsection{\texorpdfstring{managed\_elevator\_group}{managed\_elevator\_group}}
{\footnotesize\ttfamily elevator\+\_\+group\+\_\+state\+\_\+t managed\+\_\+elevator\+\_\+group\hspace{0.3cm}{\ttfamily [extern]}}



Estado del grupo de ascensores gestionado. 

Referencia externa al estado global del grupo de ascensores definido en \doxylink{main_8c}{main.\+c}. Se utiliza para acceder a información del edificio y ascensores al procesar mensajes CAN.

\begin{DoxySeeAlso}{See also}
\doxylink{main_8c}{main.\+c} 

elevator\+\_\+group\+\_\+state\+\_\+t
\end{DoxySeeAlso}
Estado del grupo de ascensores gestionado.

Estado del grupo de ascensores gestionado por este gateway.

Contiene el estado completo de todos los ascensores del edificio gestionado por este API Gateway, incluyendo posiciones actuales, tareas asignadas, estados de puertas y disponibilidad.

\begin{DoxySeeAlso}{See also}
elevator\+\_\+group\+\_\+state\+\_\+t 

elevator\+\_\+state\+\_\+manager.\+h
\end{DoxySeeAlso}
Estado del grupo de ascensores gestionado.

Declaración externa para acceder al estado del grupo de ascensores gestionado en \doxylink{main_8c}{main.\+c}. Contiene información completa de todos los ascensores del edificio.

\begin{DoxySeeAlso}{See also}
elevator\+\_\+group\+\_\+state\+\_\+t 

\doxylink{main_8c}{main.\+c}
\end{DoxySeeAlso}
Estado del grupo de ascensores gestionado por este gateway.

Contiene el estado completo de todos los ascensores del edificio gestionado por este API Gateway, incluyendo posiciones actuales, tareas asignadas, estados de puertas y disponibilidad.

\begin{DoxySeeAlso}{See also}
elevator\+\_\+group\+\_\+state\+\_\+t 

elevator\+\_\+state\+\_\+manager.\+h 
\end{DoxySeeAlso}
