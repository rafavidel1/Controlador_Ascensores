\doxysection{include/api\+\_\+gateway/api\+\_\+handlers.h File Reference}
\label{include_2api__gateway_2api__handlers_8h}\index{include/api\_gateway/api\_handlers.h@{include/api\_gateway/api\_handlers.h}}
\doxysubsubsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
struct \textbf{ api\+\_\+request\+\_\+tracker\+\_\+t}
\begin{DoxyCompactList}\small\item\em Tracks information from an original client (elevator) request OR a gateway-\/originated request. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
typedef struct \textbf{ api\+\_\+request\+\_\+tracker\+\_\+t} \textbf{ api\+\_\+request\+\_\+tracker\+\_\+t}
\begin{DoxyCompactList}\small\item\em Structure to track client requests forwarded to the central server. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
coap\+\_\+session\+\_\+t $\ast$ \textbf{ get\+\_\+or\+\_\+create\+\_\+central\+\_\+server\+\_\+dtls\+\_\+session} (struct coap\+\_\+context\+\_\+t $\ast$ctx)
\begin{DoxyCompactList}\small\item\em Obtiene o crea una sesión DTLS con el servidor central. \end{DoxyCompactList}\item 
void \textbf{ handle\+\_\+sigint\+\_\+gw} (int signum)
\begin{DoxyCompactList}\small\item\em Manejador de señal para SIGINT (Ctrl+C) \end{DoxyCompactList}\item 
coap\+\_\+response\+\_\+t \textbf{ hnd\+\_\+central\+\_\+server\+\_\+response\+\_\+gw} (coap\+\_\+session\+\_\+t $\ast$session\+\_\+to\+\_\+central, const coap\+\_\+pdu\+\_\+t $\ast$sent\+\_\+to\+\_\+central, const coap\+\_\+pdu\+\_\+t $\ast$received\+\_\+from\+\_\+central, const coap\+\_\+mid\+\_\+t mid\+\_\+to\+\_\+central)
\begin{DoxyCompactList}\small\item\em Manejador de respuestas del servidor central. \end{DoxyCompactList}\item 
void \textbf{ hnd\+\_\+elevator\+\_\+api\+\_\+request\+\_\+gw} (coap\+\_\+resource\+\_\+t $\ast$resource, coap\+\_\+session\+\_\+t $\ast$elevator\+\_\+session, const coap\+\_\+pdu\+\_\+t $\ast$elevator\+\_\+request\+\_\+pdu, const coap\+\_\+string\+\_\+t $\ast$query, coap\+\_\+pdu\+\_\+t $\ast$response\+\_\+placeholder)
\begin{DoxyCompactList}\small\item\em Handler for legacy elevator API requests (e.\+g., /peticion\+\_\+ascensor). Currently logs and discards such requests. \end{DoxyCompactList}\item 
void \textbf{ hnd\+\_\+cabin\+\_\+request\+\_\+from\+\_\+elevator\+\_\+gw} (coap\+\_\+resource\+\_\+t $\ast$resource, coap\+\_\+session\+\_\+t $\ast$elevator\+\_\+session, const coap\+\_\+pdu\+\_\+t $\ast$elevator\+\_\+request\+\_\+pdu, const coap\+\_\+string\+\_\+t $\ast$query, coap\+\_\+pdu\+\_\+t $\ast$response\+\_\+placeholder)
\begin{DoxyCompactList}\small\item\em Handler for cabin requests from elevator clients. Path\+: GW\+\_\+\+CABIN\+\_\+\+REQUEST\+\_\+\+PATH (e.\+g., /solicitud\+\_\+cabina\+\_\+gw) Parses query params\+: elevator\+\_\+id, target\+\_\+floor. \end{DoxyCompactList}\item 
void \textbf{ hnd\+\_\+floor\+\_\+call\+\_\+from\+\_\+elevator\+\_\+gw} (coap\+\_\+resource\+\_\+t $\ast$resource, coap\+\_\+session\+\_\+t $\ast$elevator\+\_\+session, const coap\+\_\+pdu\+\_\+t $\ast$elevator\+\_\+request\+\_\+pdu, const coap\+\_\+string\+\_\+t $\ast$query, coap\+\_\+pdu\+\_\+t $\ast$response\+\_\+placeholder)
\begin{DoxyCompactList}\small\item\em Handler for floor calls from elevator clients/external. Path\+: GW\+\_\+\+FLOOR\+\_\+\+CALL\+\_\+\+PATH (e.\+g., /llamada\+\_\+piso\+\_\+gw) Parses query params\+: floor, dir (UP/\+DOWN) \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
volatile sig\+\_\+atomic\+\_\+t \textbf{ quit\+\_\+main\+\_\+loop}
\begin{DoxyCompactList}\small\item\em Bandera global para controlar el bucle principal de la aplicación. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Typedef Documentation}
\label{include_2api__gateway_2api__handlers_8h_a35ab69cb8840cd418c5fe093acdbb57c} 
\index{api\_handlers.h@{api\_handlers.h}!api\_request\_tracker\_t@{api\_request\_tracker\_t}}
\index{api\_request\_tracker\_t@{api\_request\_tracker\_t}!api\_handlers.h@{api\_handlers.h}}
\doxysubsubsection{api\_request\_tracker\_t}
{\footnotesize\ttfamily typedef struct \textbf{ api\+\_\+request\+\_\+tracker\+\_\+t} \textbf{ api\+\_\+request\+\_\+tracker\+\_\+t}}



Structure to track client requests forwarded to the central server. 

This structure holds information about an original client request that the API Gateway has forwarded to the central server. It is used to correlate the server\textquotesingle{}s response back to the original client session and to manage state or context related to the request. 

\doxysubsection{Function Documentation}
\label{include_2api__gateway_2api__handlers_8h_a86ad67d9e4f5e5bff1724c17232dc0ff} 
\index{api\_handlers.h@{api\_handlers.h}!get\_or\_create\_central\_server\_dtls\_session@{get\_or\_create\_central\_server\_dtls\_session}}
\index{get\_or\_create\_central\_server\_dtls\_session@{get\_or\_create\_central\_server\_dtls\_session}!api\_handlers.h@{api\_handlers.h}}
\doxysubsubsection{get\_or\_create\_central\_server\_dtls\_session()}
{\footnotesize\ttfamily coap\+\_\+session\+\_\+t $\ast$ get\+\_\+or\+\_\+create\+\_\+central\+\_\+server\+\_\+dtls\+\_\+session (\begin{DoxyParamCaption}\item[{coap\+\_\+context\+\_\+t $\ast$}]{ctx }\end{DoxyParamCaption})}



Obtiene o crea una sesión DTLS con el servidor central. 


\begin{DoxyParams}{Parameters}
{\em ctx} & Contexto Co\+AP a utilizar para la sesión \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Puntero a la sesión DTLS establecida, o NULL en caso de error
\end{DoxyReturn}
Esta función implementa un patrón singleton para la gestión de sesiones DTLS con el servidor central. Reutiliza sesiones existentes cuando están activas y crea nuevas sesiones cuando es necesario.

Comportamiento\+:
\begin{DoxyEnumerate}
\item Si existe una sesión activa y establecida, la reutiliza
\item Si la sesión existe pero no está establecida, la libera y crea una nueva
\item Si no existe sesión, crea una nueva con configuración DTLS-\/\+PSK
\item Registra el manejador de eventos para gestión automática de la sesión
\end{DoxyEnumerate}

La función utiliza las siguientes configuraciones\+:
\begin{DoxyItemize}
\item IP del servidor\+: CENTRAL\+\_\+\+SERVER\+\_\+\+IP
\item Puerto del servidor\+: CENTRAL\+\_\+\+SERVER\+\_\+\+PORT ~\newline

\item Identidad PSK\+: IDENTITY\+\_\+\+TO\+\_\+\+PRESENT\+\_\+\+TO\+\_\+\+SERVER
\item Clave PSK\+: KEY\+\_\+\+FOR\+\_\+\+SERVER
\end{DoxyItemize}

\begin{DoxySeeAlso}{See also}
\doxyref{event\+\_\+handler\+\_\+gw()}{p.}{main_8c_a4d72c24b61707ff5f39a4123ca8cd833} 

\doxyref{coap\+\_\+config.\+h}{p.}{coap__config_8h} 
\end{DoxySeeAlso}
\label{include_2api__gateway_2api__handlers_8h_a7fd01dcda5b603f45f20d97c84d9260b} 
\index{api\_handlers.h@{api\_handlers.h}!handle\_sigint\_gw@{handle\_sigint\_gw}}
\index{handle\_sigint\_gw@{handle\_sigint\_gw}!api\_handlers.h@{api\_handlers.h}}
\doxysubsubsection{handle\_sigint\_gw()}
{\footnotesize\ttfamily void handle\+\_\+sigint\+\_\+gw (\begin{DoxyParamCaption}\item[{int}]{signum }\end{DoxyParamCaption})}



Manejador de señal para SIGINT (Ctrl+C) 

Signal handler for SIGINT (Ctrl+C) to allow graceful shutdown.


\begin{DoxyParams}{Parameters}
{\em signum} & Número de señal recibida (se espera SIGINT). No utilizado.\\
\hline
\end{DoxyParams}
Establece la bandera quit\+\_\+main\+\_\+loop a 1 para señalar al bucle principal de eventos que debe terminar, permitiendo una terminación elegante del API Gateway.

Esta función es registrada como manejador de SIGINT en \doxyref{main.\+c}{p.}{main_8c} y proporciona una forma limpia de cerrar la aplicación. \label{include_2api__gateway_2api__handlers_8h_a053f34293ce0f5e920e378b1cd18789e} 
\index{api\_handlers.h@{api\_handlers.h}!hnd\_cabin\_request\_from\_elevator\_gw@{hnd\_cabin\_request\_from\_elevator\_gw}}
\index{hnd\_cabin\_request\_from\_elevator\_gw@{hnd\_cabin\_request\_from\_elevator\_gw}!api\_handlers.h@{api\_handlers.h}}
\doxysubsubsection{hnd\_cabin\_request\_from\_elevator\_gw()}
{\footnotesize\ttfamily void hnd\+\_\+cabin\+\_\+request\+\_\+from\+\_\+elevator\+\_\+gw (\begin{DoxyParamCaption}\item[{coap\+\_\+resource\+\_\+t $\ast$}]{resource,  }\item[{coap\+\_\+session\+\_\+t $\ast$}]{elevator\+\_\+session,  }\item[{const coap\+\_\+pdu\+\_\+t $\ast$}]{elevator\+\_\+request\+\_\+pdu,  }\item[{const coap\+\_\+string\+\_\+t $\ast$}]{query,  }\item[{coap\+\_\+pdu\+\_\+t $\ast$}]{response\+\_\+placeholder }\end{DoxyParamCaption})}



Handler for cabin requests from elevator clients. Path\+: GW\+\_\+\+CABIN\+\_\+\+REQUEST\+\_\+\+PATH (e.\+g., /solicitud\+\_\+cabina\+\_\+gw) Parses query params\+: elevator\+\_\+id, target\+\_\+floor. 

\label{include_2api__gateway_2api__handlers_8h_aba27754223447346d8049fc61efcd6f8} 
\index{api\_handlers.h@{api\_handlers.h}!hnd\_central\_server\_response\_gw@{hnd\_central\_server\_response\_gw}}
\index{hnd\_central\_server\_response\_gw@{hnd\_central\_server\_response\_gw}!api\_handlers.h@{api\_handlers.h}}
\doxysubsubsection{hnd\_central\_server\_response\_gw()}
{\footnotesize\ttfamily coap\+\_\+response\+\_\+t hnd\+\_\+central\+\_\+server\+\_\+response\+\_\+gw (\begin{DoxyParamCaption}\item[{coap\+\_\+session\+\_\+t $\ast$}]{session\+\_\+from\+\_\+server,  }\item[{const coap\+\_\+pdu\+\_\+t $\ast$}]{sent\+\_\+to\+\_\+central,  }\item[{const coap\+\_\+pdu\+\_\+t $\ast$}]{received\+\_\+from\+\_\+central,  }\item[{const coap\+\_\+mid\+\_\+t}]{mid\+\_\+from\+\_\+server }\end{DoxyParamCaption})}



Manejador de respuestas del servidor central. 

Handles responses received from the Central Server.


\begin{DoxyParams}{Parameters}
{\em session\+\_\+from\+\_\+server} & Sesión Co\+AP desde la cual se recibió la respuesta \\
\hline
{\em sent\+\_\+to\+\_\+central} & PDU que fue enviado al servidor central \\
\hline
{\em received\+\_\+from\+\_\+central} & PDU recibido del servidor central \\
\hline
{\em mid\+\_\+from\+\_\+server} & Message ID de la respuesta del servidor \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
COAP\+\_\+\+RESPONSE\+\_\+\+OK si la respuesta se procesó correctamente
\end{DoxyReturn}
Esta función procesa las respuestas recibidas del servidor central para solicitudes de asignación de ascensores. Realiza las siguientes operaciones\+:


\begin{DoxyEnumerate}
\item {\bfseries{Validación}}\+: Verifica que se recibió un PDU válido
\item {\bfseries{Parsing JSON}}\+: Extrae y parsea el payload JSON de la respuesta
\item {\bfseries{Correlación}}\+: Encuentra el tracker original usando el token
\item {\bfseries{Procesamiento}}\+: Extrae información de asignación (ascensor\+\_\+asignado\+\_\+id, tarea\+\_\+id)
\item {\bfseries{Notificación CAN}}\+: Envía respuesta al controlador CAN correspondiente
\item {\bfseries{Limpieza}}\+: Libera recursos del tracker y memoria asociada
\end{DoxyEnumerate}

Maneja diferentes códigos de respuesta\+:
\begin{DoxyItemize}
\item 2.\+01 Created\+: Asignación exitosa
\item 4.\+xx Client Error\+: Errores de solicitud
\item 5.\+xx Server Error\+: Errores del servidor
\end{DoxyItemize}

\begin{DoxySeeAlso}{See also}
\doxyref{add\+\_\+central\+\_\+request\+\_\+tracker()}{p.}{api__handlers_8c_a7292f2cbff08db77c70629ddbac256dc} 

\doxyref{find\+\_\+and\+\_\+remove\+\_\+central\+\_\+request\+\_\+tracker()}{p.}{api__handlers_8c_a5f19bc5f95b0869d7b25b596f6767877} 

\doxyref{can\+\_\+bridge.\+h}{p.}{can__bridge_8h} 
\end{DoxySeeAlso}
\label{include_2api__gateway_2api__handlers_8h_af5a21d636796fd0fe682efedb9420894} 
\index{api\_handlers.h@{api\_handlers.h}!hnd\_elevator\_api\_request\_gw@{hnd\_elevator\_api\_request\_gw}}
\index{hnd\_elevator\_api\_request\_gw@{hnd\_elevator\_api\_request\_gw}!api\_handlers.h@{api\_handlers.h}}
\doxysubsubsection{hnd\_elevator\_api\_request\_gw()}
{\footnotesize\ttfamily void hnd\+\_\+elevator\+\_\+api\+\_\+request\+\_\+gw (\begin{DoxyParamCaption}\item[{coap\+\_\+resource\+\_\+t $\ast$}]{resource,  }\item[{coap\+\_\+session\+\_\+t $\ast$}]{elevator\+\_\+session,  }\item[{const coap\+\_\+pdu\+\_\+t $\ast$}]{elevator\+\_\+request\+\_\+pdu,  }\item[{const coap\+\_\+string\+\_\+t $\ast$}]{query,  }\item[{coap\+\_\+pdu\+\_\+t $\ast$}]{response\+\_\+placeholder }\end{DoxyParamCaption})}



Handler for legacy elevator API requests (e.\+g., /peticion\+\_\+ascensor). Currently logs and discards such requests. 

\label{include_2api__gateway_2api__handlers_8h_aadcce191828355c65cabd0862f5f5b4a} 
\index{api\_handlers.h@{api\_handlers.h}!hnd\_floor\_call\_from\_elevator\_gw@{hnd\_floor\_call\_from\_elevator\_gw}}
\index{hnd\_floor\_call\_from\_elevator\_gw@{hnd\_floor\_call\_from\_elevator\_gw}!api\_handlers.h@{api\_handlers.h}}
\doxysubsubsection{hnd\_floor\_call\_from\_elevator\_gw()}
{\footnotesize\ttfamily void hnd\+\_\+floor\+\_\+call\+\_\+from\+\_\+elevator\+\_\+gw (\begin{DoxyParamCaption}\item[{coap\+\_\+resource\+\_\+t $\ast$}]{resource,  }\item[{coap\+\_\+session\+\_\+t $\ast$}]{elevator\+\_\+session,  }\item[{const coap\+\_\+pdu\+\_\+t $\ast$}]{elevator\+\_\+request\+\_\+pdu,  }\item[{const coap\+\_\+string\+\_\+t $\ast$}]{query,  }\item[{coap\+\_\+pdu\+\_\+t $\ast$}]{response\+\_\+placeholder }\end{DoxyParamCaption})}



Handler for floor calls from elevator clients/external. Path\+: GW\+\_\+\+FLOOR\+\_\+\+CALL\+\_\+\+PATH (e.\+g., /llamada\+\_\+piso\+\_\+gw) Parses query params\+: floor, dir (UP/\+DOWN) 



\doxysubsection{Variable Documentation}
\label{include_2api__gateway_2api__handlers_8h_a8a485bed3bbf69f7556aa3167043d7e2} 
\index{api\_handlers.h@{api\_handlers.h}!quit\_main\_loop@{quit\_main\_loop}}
\index{quit\_main\_loop@{quit\_main\_loop}!api\_handlers.h@{api\_handlers.h}}
\doxysubsubsection{quit\_main\_loop}
{\footnotesize\ttfamily volatile sig\+\_\+atomic\+\_\+t quit\+\_\+main\+\_\+loop\hspace{0.3cm}{\ttfamily [extern]}}



Bandera global para controlar el bucle principal de la aplicación. 

Bandera para indicar si el bucle principal debe terminar.

Esta bandera se establece a 1 por el manejador de señal SIGINT (handle\+\_\+sigint\+\_\+gw) para indicar que la aplicación debe terminar de manera elegante.

\begin{DoxySeeAlso}{See also}
\doxyref{handle\+\_\+sigint\+\_\+gw()}{p.}{api__handlers_8c_a7fd01dcda5b603f45f20d97c84d9260b}
\end{DoxySeeAlso}
Bandera global para controlar el bucle principal de la aplicación.

Esta variable se declara como extern en api\+\_\+handlers.\+h y se define en \doxyref{main.\+c}{p.}{main_8c}. Es establecida por el manejador de señal (handle\+\_\+sigint\+\_\+gw) para detener el bucle principal de eventos.

\begin{DoxySeeAlso}{See also}
\doxyref{handle\+\_\+sigint\+\_\+gw()}{p.}{api__handlers_8c_a7fd01dcda5b603f45f20d97c84d9260b}
\end{DoxySeeAlso}
Bandera para indicar si el bucle principal debe terminar.

Esta bandera se establece a 1 por el manejador de señal SIGINT (handle\+\_\+sigint\+\_\+gw) para indicar que la aplicación debe terminar de manera elegante.

\begin{DoxySeeAlso}{See also}
\doxyref{handle\+\_\+sigint\+\_\+gw()}{p.}{api__handlers_8c_a7fd01dcda5b603f45f20d97c84d9260b} 
\end{DoxySeeAlso}
