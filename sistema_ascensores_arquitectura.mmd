---
config:
  theme: redux
  look: neo
  layout: fixed
---
flowchart TB
 subgraph SimulatorLayer["🔧 Hardware Layer"]
    direction TB
        misimulator["Mi simulator"]
        CANBus["🔌 CAN Bus simulated"]
  end
 subgraph CANInterface["CAN Interface"]
        CANBridge["🌉 CAN Bridge"]
  end
 subgraph DataManager["Data Manager"]
        StateManager["📊 State Manager"]
        JSONSerializer["📋 JSON Serializer"]
  end
 subgraph NetworkClient["Network Client"]
        CoAPClient["🌐 CoAP Client"]
        DTLSClient["🔐 DTLS Client"]
  end
 subgraph ConfigManager["Configuration"]
        EnvConfig["⚙️ Environment Config"]
  end
 subgraph APIGateway["☁️ API Gateway"]
    direction TB
        CANInterface
        DataManager
        NetworkClient
        ConfigManager
  end
 subgraph NetworkLayer["🌐 Network Layer"]
    direction TB
        DTLSTunnel["🔒 DTLS-PSK Tunnel"]
        LoadBalancer["⚖️ MetalLB LoadBalancer"]
  end
 subgraph KubernetesLayer["🚢 Kubernetes Layer"]
    direction TB
        K8sService["🔀 Service"]
        K8sDeployment["📦 Deployment"]
        K8sPod["🎯 Pod"]
  end
 subgraph NetworkStack["Network Stack"]
        CoAPServer["🌐 CoAP Server"]
        DTLSServer["🔐 DTLS Server"]
  end
 subgraph SecurityLayer["Security Layer"]
        PSKValidator["🔑 PSK Validator"]
  end
 subgraph BusinessLogic["Business Logic"]
        JSONParser["📖 JSON Parser"]
        TaskScheduler["⚡ Task Scheduler"]
  end
 subgraph ResponseHandler["Response Handler"]
        ResponseGenerator["📤 Response Generator"]
        TaskIDGenerator["🔢 Task ID Generator"]
  end
 subgraph ServidorCentral["🗄️ Servidor Central"]
    direction TB
        NetworkStack
        SecurityLayer
        BusinessLogic
        ResponseHandler
  end
    CANBus -- simulated_can_frame_t<br>ID: 0x100, 0x200, 0x300<br>Data: uint8_t[8] --> CANBridge
    CANBridge -- gw_request_type_t<br>api_request_details_for_json_t --> StateManager
    StateManager -- elevator_group_state_t<br>elevator_status_t[] --> JSONSerializer
    JSONSerializer -- FloorCallRequest JSON<br>CabinRequest JSON --> CoAPClient
    CoAPClient -- CoAP POST /peticion_piso<br>CoAP POST /peticion_cabina<br>JSON payload --> DTLSTunnel
    DTLSTunnel -- "DTLS-PSK encrypted CoAP<br>AES-128-CCM-8<br>UDP packets" --> LoadBalancer
    LoadBalancer -- UDP traffic<br>Port 5684<br>Load balanced --> K8sService
    K8sService -- Service routing<br>Pod selection --> K8sPod
    K8sPod -- Container networking<br>Process routing --> CoAPServer
    CoAPServer -- coap_pdu_t<br>coap_session_t --> DTLSServer
    DTLSServer -- PSK identity<br>Validation request --> PSKValidator
    PSKValidator -- Authentication result<br>Session context --> JSONParser
    JSONParser -- Parsed JSON objects<br>Validation result --> TaskScheduler
    TaskScheduler -- Task assignment<br>Elevator selection --> ResponseGenerator
    ResponseGenerator -- ServerResponse JSON<br>Task details --> TaskIDGenerator
    TaskIDGenerator -- Generated tarea_id<br>Unique identifier --> ResponseGenerator
    ResponseGenerator -- Complete ServerResponse<br>ascensor_asignado_id<br>tarea_id<br>piso_destino_asignado --> CoAPServer
    CoAPServer -- CoAP 200 OK<br>JSON response --> K8sPod
    PSKValidator -. Key lookup<br>Identity validation .-> PSKKeysFile["PSKKeysFile"]
    CoAPServer -. Event logging<br>Audit trail .-> LogFiles["LogFiles"]
    EnvConfig -. Runtime configuration<br>Environment variables .-> ConfigFiles["ConfigFiles"]
    EnvConfig -. "DTLS-PSK configuration<br>Server endpoints" .-> DTLSClient
    EnvConfig -. Network configuration<br>Timeouts, retries .-> CoAPClient
     CANBus:::hardwareStyle
     CANBridge:::gatewayStyle
     StateManager:::gatewayStyle
     JSONSerializer:::gatewayStyle
     CoAPClient:::gatewayStyle
     DTLSClient:::gatewayStyle
     EnvConfig:::gatewayStyle
     DTLSTunnel:::networkStyle
     LoadBalancer:::networkStyle
     K8sService:::k8sStyle
     K8sDeployment:::k8sStyle
     K8sPod:::k8sStyle
     CoAPServer:::serverStyle
     DTLSServer:::serverStyle
     PSKValidator:::serverStyle
     JSONParser:::serverStyle
     TaskScheduler:::serverStyle
     ResponseGenerator:::serverStyle
     TaskIDGenerator:::serverStyle
     PSKKeysFile:::storageStyle
     LogFiles:::storageStyle
     ConfigFiles:::storageStyle
    classDef hardwareStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef gatewayStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px  
    classDef networkStyle fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef k8sStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef serverStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef storageStyle fill:#f1f8e9,stroke:#33691e,stroke-width:2px
